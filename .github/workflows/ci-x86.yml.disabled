name: CI (x86)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-x86-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.6'
  WIRE_VERSION: 'v0.7.0'
  RUST_VERSION: 'stable'
  ZIG_VERSION: '0.13.0'

jobs:
  # =============================================================================
  # PHASE 1: QUALITY GATES
  # =============================================================================

  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-lint-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-lint-

      - name: Check formatting
        working-directory: src/lib/probe
        run: cargo fmt --all -- --check

      - name: Run clippy
        working-directory: src/lib/probe
        run: cargo clippy --all-features -- -D warnings

  rust-test:
    name: Rust Test
    runs-on: ubuntu-24.04
    needs: [rust-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-test-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-test-

      - name: Run tests
        working-directory: src/lib/probe
        run: cargo test

  # =============================================================================
  # PHASE 2: BUILD LIBPROBE (x86 platforms)
  # =============================================================================

  # Native Linux builds
  build-probe-linux:
    name: Build Probe linux-${{ matrix.platform }}
    runs-on: ubuntu-24.04
    needs: [rust-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: x86_64-unknown-linux-gnu
            platform: linux-amd64
          - rust_target: x86_64-unknown-linux-musl
            platform: linux-amd64-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install musl tools
        if: matrix.musl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq musl-tools

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.musl && 'musl-gcc' || 'gcc' }}
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # BSD cross-compilation with Zig
  build-probe-bsd:
    name: Build Probe ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    needs: [rust-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: x86_64-unknown-freebsd
            platform: freebsd-amd64
            zig_target: x86_64-freebsd
          - rust_target: x86_64-unknown-openbsd
            platform: openbsd-amd64
            zig_target: x86_64-openbsd
          - rust_target: x86_64-unknown-netbsd
            platform: netbsd-amd64
            zig_target: x86_64-netbsd
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-${{ matrix.rust_target }}-

      - name: Configure Cargo for Zig cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.${{ matrix.rust_target }}]
          linker = "${{ github.workspace }}/zig-wrapper.sh"
          ar = "zig"
          EOF

          # Create Zig wrapper script
          cat > zig-wrapper.sh << 'WRAPPER'
          #!/bin/sh
          exec zig cc -target ${{ matrix.zig_target }} "$@"
          WRAPPER
          chmod +x zig-wrapper.sh

      - name: Build libprobe.a (cross-compile)
        working-directory: src/lib/probe
        env:
          CC: "${{ github.workspace }}/zig-wrapper.sh"
          AR: "zig ar"
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # DragonFlyBSD (separate due to different Zig target format)
  build-probe-dragonfly:
    name: Build Probe dragonfly-amd64
    runs-on: ubuntu-24.04
    needs: [rust-test]
    continue-on-error: true  # DragonFly support in Zig may be limited
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Add DragonFly target
        run: rustup target add x86_64-unknown-dragonfly || echo "DragonFly target may not be available in stable"

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-dragonfly-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-dragonfly-

      - name: Configure Cargo for cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.x86_64-unknown-dragonfly]
          linker = "${{ github.workspace }}/zig-wrapper.sh"
          EOF

          cat > zig-wrapper.sh << 'WRAPPER'
          #!/bin/sh
          # DragonFly uses a variant of FreeBSD target in Zig
          exec zig cc -target x86_64-freebsd "$@"
          WRAPPER
          chmod +x zig-wrapper.sh

      - name: Build libprobe.a (cross-compile)
        working-directory: src/lib/probe
        run: cargo build --release --target x86_64-unknown-dragonfly || echo "DragonFly build failed - will use VM fallback"

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/dragonfly-amd64
          if [ -f src/lib/probe/target/x86_64-unknown-dragonfly/release/libprobe.a ]; then
            cp src/lib/probe/target/x86_64-unknown-dragonfly/release/libprobe.a dist/lib/dragonfly-amd64/
          else
            echo "DragonFly libprobe not built - VM will handle this"
            touch dist/lib/dragonfly-amd64/.placeholder
          fi

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-dragonfly-amd64
          path: dist/lib/dragonfly-amd64/
          retention-days: 1
          if-no-files-found: warn

  # macOS Intel (native)
  build-probe-darwin-amd64:
    name: Build Probe darwin-amd64
    runs-on: macos-13
    needs: [rust-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-darwin-amd64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-darwin-amd64-

      - name: Build libprobe.a (native)
        working-directory: src/lib/probe
        run: cargo build --release

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/darwin-amd64
          cp src/lib/probe/target/release/libprobe.a dist/lib/darwin-amd64/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-darwin-amd64
          path: dist/lib/darwin-amd64/libprobe.a
          retention-days: 1

  # =============================================================================
  # PHASE 3: GO TESTS (uses linux-amd64 probe)
  # =============================================================================

  go-test:
    name: Go Test
    runs-on: ubuntu-24.04
    needs: [build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe (amd64)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-amd64
          path: dist/lib/linux-amd64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        env:
          GOWORK: off
        run: wire ./internal/bootstrap/

      - name: Run golangci-lint (full, with CGO)
        working-directory: src
        env:
          GOWORK: off
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-amd64 -lprobe -lpthread -ldl -lm"
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | \
            sh -s -- -b $(go env GOPATH)/bin v2.8.0
          golangci-lint run -c ../.golangci.yml --timeout 5m

      - name: Run tests with race detector
        working-directory: src
        env:
          GOWORK: off
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-amd64 -lprobe -lpthread -ldl -lm"
        run: go test -race -p=4 -coverprofile=coverage.raw.out -covermode=atomic ./...

      - name: Filter coverage
        working-directory: src
        run: |
          set -euo pipefail
          head -1 coverage.raw.out > coverage.out
          grep -v -E '\.pb\.go:|wire_gen\.go:|mock_.*\.go:' coverage.raw.out >> coverage.out || true

      - name: Upload coverage to Codacy
        continue-on-error: true
        working-directory: src
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: supervizio
          CODACY_PROJECT_NAME: daemon
        run: |
          set -euo pipefail
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            --force-coverage-parser go \
            -r coverage.out

  # =============================================================================
  # PHASE 4: BUILD BINARIES (x86 platforms)
  # =============================================================================

  # Linux glibc binaries
  build-linux-amd64:
    name: Build linux-amd64
    runs-on: ubuntu-24.04
    needs: [go-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-amd64
          path: dist/lib/linux-amd64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-amd64 -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-linux-amd64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-amd64
          path: supervizio-linux-amd64
          retention-days: 1

  # Linux musl (static) binaries
  build-linux-amd64-musl:
    name: Build linux-amd64-musl
    runs-on: ubuntu-24.04
    needs: [go-test, build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-amd64-musl
          path: dist/lib/linux-amd64-musl/

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/src \
            -e CGO_ENABLED=1 \
            -e CGO_CFLAGS="-I/workspace/src/lib/probe/include" \
            -e CGO_LDFLAGS="-L/workspace/dist/lib/linux-amd64-musl -lprobe -lm" \
            golang:1.25-alpine \
            sh -c '
              set -euo pipefail
              apk add --no-cache gcc musl-dev file
              go install github.com/google/wire/cmd/wire@v0.7.0
              wire ./internal/bootstrap/
              go build -v \
                -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci -linkmode external -extldflags \"-static\"" \
                -o /workspace/supervizio-linux-amd64-musl \
                ./cmd/daemon
              file /workspace/supervizio-linux-amd64-musl
            '

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-amd64-musl
          path: supervizio-linux-amd64-musl
          retention-days: 1

  # BSD binaries (cross-compiled with CGO)
  build-bsd-amd64:
    name: Build ${{ matrix.goos }}-amd64
    runs-on: ubuntu-24.04
    needs: [go-test, build-probe-bsd]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: freebsd
            probe: freebsd-amd64
          - goos: openbsd
            probe: openbsd-amd64
          - goos: netbsd
            probe: netbsd-amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-${{ matrix.probe }}
          path: dist/lib/${{ matrix.probe }}/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Setup Zig as C compiler for CGO
        run: |
          # Create zig-cc wrapper for BSD target
          cat > /usr/local/bin/zig-cc-${{ matrix.goos }} << 'EOF'
          #!/bin/sh
          exec zig cc -target x86_64-${{ matrix.goos }} "$@"
          EOF
          chmod +x /usr/local/bin/zig-cc-${{ matrix.goos }}

      - name: Build binary (cross-compile)
        working-directory: src
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: amd64
          CGO_ENABLED: 1
          CC: zig-cc-${{ matrix.goos }}
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/${{ matrix.probe }} -lprobe -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-${{ matrix.goos }}-amd64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.goos }}-amd64
          path: supervizio-${{ matrix.goos }}-amd64
          retention-days: 1

  # macOS Intel binary
  build-darwin-amd64:
    name: Build darwin-amd64
    runs-on: macos-13
    needs: [go-test, build-probe-darwin-amd64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-darwin-amd64
          path: dist/lib/darwin-amd64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/darwin-amd64 -lprobe"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-darwin-amd64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-darwin-amd64
          path: supervizio-darwin-amd64
          retention-days: 1

  # Crasher for E2E tests
  build-crasher:
    name: Build crasher
    runs-on: ubuntu-24.04
    needs: [go-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Build crasher
        working-directory: e2e/behavioral/crasher
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
          GOWORK: off
        run: go build -ldflags="-s -w" -o crasher .

      - name: Upload crasher
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: crasher-linux-amd64
          path: e2e/behavioral/crasher/crasher
          retention-days: 1

  # =============================================================================
  # PHASE 5: VERIFY ARTIFACTS
  # =============================================================================

  verify-artifacts:
    name: Verify Artifacts
    runs-on: ubuntu-24.04
    needs: [build-linux-amd64, build-linux-amd64-musl]
    steps:
      - name: Download all Linux binaries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: supervizio-linux-*
          merge-multiple: true
          path: bin/

      - name: Verify binaries
        run: |
          set -euo pipefail
          echo "=== Verifying binaries ==="
          for bin in bin/supervizio-*; do
            if [ -f "$bin" ]; then
              echo "Checking $bin..."
              file "$bin"
              chmod +x "$bin"
            fi
          done

      - name: Verify musl is static
        run: |
          set -euo pipefail
          if [ -f bin/supervizio-linux-amd64-musl ]; then
            if ! file bin/supervizio-linux-amd64-musl | grep -qE "statically linked|static-pie"; then
              echo "ERROR: musl binary is NOT statically linked!"
              exit 1
            fi
            echo "OK: musl binary is static"
          fi

      - name: Generate checksums
        run: |
          cd bin
          sha256sum supervizio-* > checksums.txt
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: checksums-x86
          path: bin/checksums.txt
          retention-days: 1

  # =============================================================================
  # PHASE 6: E2E TESTS (x86)
  # =============================================================================

  e2e-testcontainer:
    name: E2E Testcontainer
    runs-on: ubuntu-24.04
    needs: [build-linux-amd64-musl, build-crasher]
    continue-on-error: true
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download supervizio binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-amd64-musl
          path: bin/

      - name: Download crasher binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: crasher-linux-amd64
          path: bin/

      - name: Prepare binaries
        run: |
          mv bin/supervizio-linux-amd64-musl bin/supervizio
          chmod +x bin/*

      - name: Download Go dependencies
        working-directory: e2e/behavioral
        env:
          GOWORK: off
        run: go mod download

      - name: Run behavioral tests
        working-directory: e2e/behavioral
        env:
          GOWORK: off
          TESTCONTAINERS_RYUK_DISABLED: "true"
        run: go test -v -timeout 15m ./...

  e2e-docker-linux:
    name: E2E Docker ${{ matrix.name }}
    needs: [build-linux-amd64, build-linux-amd64-musl]
    runs-on: ubuntu-24.04
    continue-on-error: true
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian-glibc
            dockerfile: Dockerfile.debian-script
            artifact: supervizio-linux-amd64
          - name: Alpine-musl
            dockerfile: Dockerfile.alpine-script
            artifact: supervizio-linux-amd64-musl
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Prepare binary
        run: |
          if [ "${{ matrix.artifact }}" != "supervizio-linux-amd64" ]; then
            mv bin/${{ matrix.artifact }} bin/supervizio-linux-amd64
          fi
          file bin/supervizio-linux-amd64

      - name: Build and test container
        run: |
          docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-e2e:${{ matrix.name }} .
          docker run --rm supervizio-e2e:${{ matrix.name }}
          docker run --rm --entrypoint sh supervizio-e2e:${{ matrix.name }} -c "
            OUTPUT=\$(/usr/local/bin/supervizio --probe) &&
            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' &&
            echo 'Probe validation passed'
          "

  # E2E VM tests for BSD (uses pre-built cross-compiled binaries)
  e2e-vm-bsd:
    name: E2E VM ${{ matrix.name }}
    needs: [build-bsd-amd64]
    runs-on: ubuntu-24.04
    continue-on-error: true
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: FreeBSD
            vm: freebsd
            goos: freebsd
          - name: OpenBSD
            vm: openbsd
            goos: openbsd
          - name: NetBSD
            vm: netbsd
            goos: netbsd
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download BSD binary (cross-compiled)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-${{ matrix.goos }}-amd64
          path: bin/

      - name: Prepare binary
        run: |
          mv bin/supervizio-${{ matrix.goos }}-amd64 bin/supervizio
          chmod +x bin/supervizio

      - name: Setup KVM
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y -qq libvirt-daemon-system libvirt-dev libvirt-clients qemu-kvm ruby-dev ruby-libvirt build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq && sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-v1

      - name: Start VM
        working-directory: e2e
        timeout-minutes: 12
        run: sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt

      - name: Wait for VM and copy binary
        working-directory: e2e
        timeout-minutes: 5
        run: |
          set -uo pipefail
          sudo -E vagrant ssh-config ${{ matrix.vm }} 2>&1 | tee /tmp/ssh-config || true
          VM_IP=$(grep HostName /tmp/ssh-config | awk '{print $2}')

          for i in $(seq 1 36); do
            if timeout 5 bash -c "echo >/dev/tcp/$VM_IP/22" 2>/dev/null; then
              if sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'SSH ready'" 2>/dev/null; then
                break
              fi
            fi
            [ "$i" = "36" ] && exit 1
            sleep 5
          done

          # Copy pre-built binary to VM
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo mkdir -p /usr/local/bin"
          tar -cf - -C .. bin | sudo -E vagrant ssh ${{ matrix.vm }} -c "cd / && sudo tar -xf - && sudo mv /bin/supervizio /usr/local/bin/ && sudo chmod +x /usr/local/bin/supervizio"

      - name: Test binary in VM
        working-directory: e2e
        timeout-minutes: 5
        run: |
          echo "=== Test version ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "/usr/local/bin/supervizio --version"

          echo "=== Test probes ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "
            OUTPUT=\$(/usr/local/bin/supervizio --probe)
            echo \"\$OUTPUT\" | jq .
            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' &&
            echo 'Probe validation passed on ${{ matrix.name }}'
          "

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

  # =============================================================================
  # PHASE 7: PACKAGES (x86)
  # =============================================================================

  packages-glibc:
    name: Package ${{ matrix.format }} (amd64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-amd64

      - name: Prepare binary
        run: chmod +x supervizio-linux-amd64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: amd64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager ${{ matrix.format }} --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-amd64.${{ matrix.format }}
          path: "*.${{ matrix.format }}"
          retention-days: 1

  packages-musl:
    name: Package apk (amd64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-amd64-musl

      - name: Prepare binary
        run: |
          mv supervizio-linux-amd64-musl supervizio-linux-amd64
          chmod +x supervizio-linux-amd64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: amd64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager apk --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-amd64.apk
          path: "*.apk"
          retention-days: 1
