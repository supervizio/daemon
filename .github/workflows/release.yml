name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'src/cmd/**'
      - 'src/internal/**'
      - 'src/go.mod'
      - 'src/go.sum'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  GO_VERSION: '1.25.5'

jobs:
  # =============================================================================
  # Determine version (single job to avoid race conditions)
  # =============================================================================
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION_NUM=${LATEST_TAG#v}
            MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
            MINOR=$(echo $VERSION_NUM | cut -d. -f2)
            PATCH=$(echo $VERSION_NUM | cut -d. -f3)
            PATCH=$((PATCH + 1))
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # =============================================================================
  # Native builds (fast, on native hardware)
  # =============================================================================
  build-native:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    needs: version
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux native
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
          - runner: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
          # macOS native
          - runner: macos-13
            goos: darwin
            goarch: amd64
          - runner: macos-latest
            goos: darwin
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 0
        run: |
          go build -buildvcs=false \
            -ldflags="-s -w -X main.version=${{ needs.version.outputs.version }}" \
            -o ../daemon-${{ matrix.goos }}-${{ matrix.goarch }} \
            ./cmd/daemon

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-${{ matrix.goos }}-${{ matrix.goarch }}
          path: daemon-${{ matrix.goos }}-${{ matrix.goarch }}
          retention-days: 1

  # =============================================================================
  # Cross-compiled builds (parallel on ubuntu-latest)
  # =============================================================================
  build-cross:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    needs: version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux additional architectures
          - goos: linux
            goarch: arm
          - goos: linux
            goarch: 386
          - goos: linux
            goarch: riscv64
          # FreeBSD
          - goos: freebsd
            goarch: amd64
          - goos: freebsd
            goarch: arm64
          - goos: freebsd
            goarch: arm
          - goos: freebsd
            goarch: 386
          - goos: freebsd
            goarch: riscv64
          # OpenBSD
          - goos: openbsd
            goarch: amd64
          - goos: openbsd
            goarch: arm64
          - goos: openbsd
            goarch: arm
          - goos: openbsd
            goarch: 386
          # NetBSD
          - goos: netbsd
            goarch: amd64
          - goos: netbsd
            goarch: arm64
          - goos: netbsd
            goarch: arm
          - goos: netbsd
            goarch: 386
          # DragonFlyBSD
          - goos: dragonfly
            goarch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        working-directory: src
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build -buildvcs=false \
            -ldflags="-s -w -X main.version=${{ needs.version.outputs.version }}" \
            -o ../daemon-${{ matrix.goos }}-${{ matrix.goarch }} \
            ./cmd/daemon

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-${{ matrix.goos }}-${{ matrix.goarch }}
          path: daemon-${{ matrix.goos }}-${{ matrix.goarch }}
          retention-days: 1

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  release:
    name: Create Release
    needs: [version, build-native, build-cross]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Flatten artifacts and generate checksums
          cd artifacts
          for dir in */; do
            for file in "$dir"*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                mv "$file" ../release/
                (cd ../release && sha256sum "$filename" >> checksums.txt)
              fi
            done
          done

          cd ../release
          echo "=== Release assets ==="
          ls -la
          echo ""
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Generate release notes
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          cat > release-notes.md << EOF
          ## Daemon ${VERSION}

          PID1-capable process supervisor for containers and Unix systems.

          ### Supported Platforms

          | OS | amd64 | arm64 | arm | 386 | riscv64 |
          |----|:-----:|:-----:|:---:|:---:|:-------:|
          | Linux | ✅ | ✅ | ✅ | ✅ | ✅ |
          | macOS | ✅ | ✅ | - | - | - |
          | FreeBSD | ✅ | ✅ | ✅ | ✅ | ✅ |
          | OpenBSD | ✅ | ✅ | ✅ | ✅ | - |
          | NetBSD | ✅ | ✅ | ✅ | ✅ | - |
          | DragonFlyBSD | ✅ | - | - | - | - |

          ### Quick Install

          \`\`\`bash
          # Auto-detect and install
          OS=\$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=\$(uname -m)
          case \$ARCH in
            x86_64)  ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
            armv7l)  ARCH="arm" ;;
            i686)    ARCH="386" ;;
          esac

          curl -fsSL ${BASE_URL}/daemon-\${OS}-\${ARCH} -o daemon
          chmod +x daemon
          sudo mv daemon /usr/local/bin/
          \`\`\`

          ### Checksums (SHA256)

          \`\`\`
          $(cat release/checksums.txt)
          \`\`\`
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Daemon ${{ needs.version.outputs.version }}
          tag_name: ${{ needs.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.version.outputs.version, '-') }}
          files: release/*
          token: ${{ secrets.GITHUB_TOKEN }}
