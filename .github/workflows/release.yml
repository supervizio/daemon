name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'      # v1.0.0
      - 'v[0-9]+.[0-9]+.[0-9]+-*'    # v1.0.0-rc.1, v1.0.0-beta.1
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type (auto = detect from commits)'
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: auto

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

env:
  GO_VERSION: '1.25.6'
  WIRE_VERSION: 'v0.7.0'
  RUST_VERSION: 'stable'

jobs:
  # =============================================================================
  # Determine version
  # =============================================================================
  version:
    name: Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_num: ${{ steps.version.outputs.version_num }}
      is_new_tag: ${{ steps.version.outputs.is_new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          set -euo pipefail
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            IS_NEW_TAG="false"
            BUMP_TYPE="tag"
            LATEST_TAG="$VERSION"
          else
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION_NUM=${LATEST_TAG#v}

            IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION_NUM%%-*}"
            MAJOR=${MAJOR:-0}
            MINOR=${MINOR:-0}
            PATCH=${PATCH:-0}

            BUMP_TYPE="${{ inputs.bump }}"

            if [[ "$BUMP_TYPE" == "auto" || -z "$BUMP_TYPE" ]]; then
              echo "Analyzing commits since $LATEST_TAG..."

              if [[ "$LATEST_TAG" == "v0.0.0" ]]; then
                COMMITS=$(git log --oneline --format="%s")
              else
                COMMITS=$(git log "${LATEST_TAG}..HEAD" --oneline --format="%s")
              fi

              echo "Commits found:"
              echo "$COMMITS" | head -20

              if echo "$COMMITS" | grep -qiE '^[a-z]+(\(.+\))?!:|BREAKING CHANGE:'; then
                BUMP_TYPE="major"
                echo "Detected: BREAKING CHANGE → major"
              elif echo "$COMMITS" | grep -qiE '^feat(\(.+\))?:'; then
                BUMP_TYPE="minor"
                echo "Detected: feat commits → minor"
              elif echo "$COMMITS" | grep -qiE '^fix(\(.+\))?:'; then
                BUMP_TYPE="patch"
                echo "Detected: fix commits → patch"
              else
                BUMP_TYPE="patch"
                echo "No conventional commits detected → patch (default)"
              fi
            fi

            case "$BUMP_TYPE" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            IS_NEW_TAG="true"
          fi

          VERSION_NUM="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "is_new_tag=${IS_NEW_TAG}" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Version Summary ==="
          echo "Previous: $LATEST_TAG"
          echo "Bump: $BUMP_TYPE"
          echo "New: $VERSION"

  # =============================================================================
  # PHASE 1: BUILD PROBES (same as CI)
  # =============================================================================

  build-probe-linux:
    name: Probe linux-amd64${{ matrix.suffix }}
    runs-on: ubuntu-24.04
    needs: [version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: x86_64-unknown-linux-gnu
            suffix: ""
            platform: linux-amd64
          - rust_target: x86_64-unknown-linux-musl
            suffix: "-musl"
            platform: linux-amd64-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install musl tools
        if: matrix.musl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq musl-tools

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-x86-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-x86-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.musl && 'musl-gcc' || 'gcc' }}
        run: cargo build --release --target ${{ matrix.rust_target }} --package probe-ffi

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  build-probe-linux-arm64:
    name: Probe linux-arm64${{ matrix.suffix }}
    runs-on: ubuntu-24.04-arm
    needs: [version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: aarch64-unknown-linux-gnu
            suffix: ""
            platform: linux-arm64
          - rust_target: aarch64-unknown-linux-musl
            suffix: "-musl"
            platform: linux-arm64-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install musl tools
        if: matrix.musl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq musl-tools

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-arm64-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-arm64-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.musl && 'musl-gcc' || 'gcc' }}
        run: cargo build --release --target ${{ matrix.rust_target }} --package probe-ffi

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # Linux cross-compiled probes (arm, 386, riscv64 on x86_64 runner)
  build-probe-linux-cross:
    name: Probe ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    needs: [version]
    strategy:
      fail-fast: false
      matrix:
        include:
          # glibc targets (apt cross-compilers)
          - rust_target: armv7-unknown-linux-gnueabihf
            platform: linux-arm
            cc: arm-linux-gnueabihf-gcc
            packages: gcc-arm-linux-gnueabihf
          - rust_target: i686-unknown-linux-gnu
            platform: linux-386
            cc: i686-linux-gnu-gcc
            packages: gcc-i686-linux-gnu
          - rust_target: riscv64gc-unknown-linux-gnu
            platform: linux-riscv64
            cc: riscv64-linux-gnu-gcc
            packages: gcc-riscv64-linux-gnu
          # musl targets (Zig CC)
          - rust_target: armv7-unknown-linux-musleabihf
            platform: linux-arm-musl
            cc: zig-cc
            zig_target: arm-linux-musleabihf
            musl: true
          - rust_target: i686-unknown-linux-musl
            platform: linux-386-musl
            cc: zig-cc
            zig_target: x86-linux-musl
            musl: true
          - rust_target: riscv64gc-unknown-linux-musl
            platform: linux-riscv64-musl
            cc: zig-cc
            zig_target: riscv64-linux-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install cross-compiler (glibc)
        if: ${{ !matrix.musl }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ${{ matrix.packages }}

      - name: Install Zig (musl CC)
        if: ${{ matrix.musl }}
        env:
          ZIG_TARGET: ${{ matrix.zig_target }}
        run: |
          curl -fL --retry 3 "https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz" | tar xJ -C /opt
          echo "/opt/zig-linux-x86_64-0.13.0" >> "$GITHUB_PATH"
          printf '#!/bin/sh\nexec /opt/zig-linux-x86_64-0.13.0/zig cc -target %s "$@"\n' "$ZIG_TARGET" > /usr/local/bin/zig-cc
          chmod +x /usr/local/bin/zig-cc

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-cross-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-cross-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.cc }}
        run: cargo build --release --target ${{ matrix.rust_target }} --package probe-ffi

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  build-probe-darwin:
    name: Probe darwin-amd64
    runs-on: macos-15-intel
    needs: [version]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-darwin-amd64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-darwin-amd64-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'
        run: cargo build --release --target x86_64-apple-darwin --package probe-ffi

      - name: Prepare artifact
        working-directory: src/lib/probe
        run: |
          mkdir -p ${{ github.workspace }}/dist/lib/darwin-amd64
          cp target/x86_64-apple-darwin/release/libprobe.a ${{ github.workspace }}/dist/lib/darwin-amd64/
          ls -la ${{ github.workspace }}/dist/lib/darwin-amd64/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-darwin-amd64
          path: dist/lib/darwin-amd64/libprobe.a
          retention-days: 1

  build-probe-darwin-arm64:
    name: Probe darwin-arm64
    runs-on: macos-15
    needs: [version]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-darwin-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-darwin-arm64-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'
        run: cargo build --release --target aarch64-apple-darwin --package probe-ffi

      - name: Prepare artifact
        working-directory: src/lib/probe
        run: |
          mkdir -p ${{ github.workspace }}/dist/lib/darwin-arm64
          cp target/aarch64-apple-darwin/release/libprobe.a ${{ github.workspace }}/dist/lib/darwin-arm64/
          ls -la ${{ github.workspace }}/dist/lib/darwin-arm64/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/libprobe.a
          retention-days: 1

  # =============================================================================
  # PHASE 2: BUILD BINARIES (all CGO_ENABLED=1 with probe)
  # =============================================================================

  build-linux-amd64:
    name: Build linux-amd64
    runs-on: ubuntu-24.04
    needs: [version, build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-amd64
          path: dist/lib/linux-amd64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-amd64 -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o ../supervizio-linux-amd64 ./cmd/daemon

      - name: Probe smoke test
        run: |
          chmod +x supervizio-linux-amd64
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-linux-amd64 probe-cap-linux-amd64.json

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-amd64
          path: supervizio-linux-amd64
          retention-days: 1

  build-linux-amd64-musl:
    name: Build linux-amd64-musl
    runs-on: ubuntu-24.04
    needs: [version, build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-amd64-musl
          path: dist/lib/linux-amd64-musl/

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/src \
            -e CGO_ENABLED=1 \
            -e CGO_CFLAGS="-I/workspace/src/lib/probe/include" \
            -e CGO_LDFLAGS="-L/workspace/dist/lib/linux-amd64-musl -lprobe -lm" \
            golang:1.25-alpine \
            sh -c '
              set -euo pipefail
              apk add --no-cache gcc musl-dev file
              go install github.com/google/wire/cmd/wire@v0.7.0
              wire ./internal/bootstrap/
              go build -v \
                -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }} -linkmode external -extldflags \"-static\"" \
                -o /workspace/supervizio-linux-amd64-musl \
                ./cmd/daemon
              file /workspace/supervizio-linux-amd64-musl
            '

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-amd64-musl
          path: supervizio-linux-amd64-musl
          retention-days: 1

      - name: Probe smoke test
        run: |
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-linux-amd64-musl probe-cap-linux-amd64-musl.json

  build-linux-arm64:
    name: Build linux-arm64
    runs-on: ubuntu-24.04-arm
    needs: [version, build-probe-linux-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64
          path: dist/lib/linux-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-arm64 -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o ../supervizio-linux-arm64 ./cmd/daemon

      - name: Probe smoke test
        run: |
          chmod +x supervizio-linux-arm64
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-linux-arm64 probe-cap-linux-arm64.json

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64
          path: supervizio-linux-arm64
          retention-days: 1

  build-linux-arm64-musl:
    name: Build linux-arm64-musl
    runs-on: ubuntu-24.04-arm
    needs: [version, build-probe-linux-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64-musl
          path: dist/lib/linux-arm64-musl/

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/src \
            -e CGO_ENABLED=1 \
            -e CGO_CFLAGS="-I/workspace/src/lib/probe/include" \
            -e CGO_LDFLAGS="-L/workspace/dist/lib/linux-arm64-musl -lprobe -lm" \
            golang:1.25-alpine \
            sh -c '
              set -euo pipefail
              apk add --no-cache gcc musl-dev file
              go install github.com/google/wire/cmd/wire@v0.7.0
              wire ./internal/bootstrap/
              go build -v \
                -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }} -linkmode external -extldflags \"-static\"" \
                -o /workspace/supervizio-linux-arm64-musl \
                ./cmd/daemon
              file /workspace/supervizio-linux-arm64-musl
            '

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64-musl
          path: supervizio-linux-arm64-musl
          retention-days: 1

      - name: Probe smoke test
        run: |
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-linux-arm64-musl probe-cap-linux-arm64-musl.json

  # Linux cross-compiled binaries (arm, 386, riscv64 on x86_64 runner)
  build-linux-cross:
    name: Build ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    needs: [version, build-probe-linux-cross]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goarch: arm
            goarm: "7"
            platform: linux-arm
            cc: arm-linux-gnueabihf-gcc
            packages: gcc-arm-linux-gnueabihf
          - goarch: 386
            platform: linux-386
            cc: i686-linux-gnu-gcc
            packages: gcc-i686-linux-gnu
          - goarch: riscv64
            platform: linux-riscv64
            cc: riscv64-linux-gnu-gcc
            packages: gcc-riscv64-linux-gnu
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/

      - name: Install cross-compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ${{ matrix.packages }}

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CC: ${{ matrix.cc }}
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/${{ matrix.platform }} -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o ../supervizio-${{ matrix.platform }} ./cmd/daemon

      - name: Verify binary architecture
        run: file supervizio-${{ matrix.platform }}

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.platform }}
          path: supervizio-${{ matrix.platform }}
          retention-days: 1

  # Linux cross-compiled musl binaries (arm, 386, riscv64 — static, Zig CC)
  build-linux-cross-musl:
    name: Build ${{ matrix.platform }}-musl
    runs-on: ubuntu-24.04
    needs: [version, build-probe-linux-cross]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goarch: arm
            goarm: "7"
            platform: linux-arm
            cc: zig-cc
            zig_target: arm-linux-musleabihf
          - goarch: 386
            platform: linux-386
            cc: zig-cc
            zig_target: x86-linux-musl
          - goarch: riscv64
            platform: linux-riscv64
            cc: zig-cc
            zig_target: riscv64-linux-musl
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-${{ matrix.platform }}-musl
          path: dist/lib/${{ matrix.platform }}-musl/

      - name: Install Zig (musl CC)
        env:
          ZIG_TARGET: ${{ matrix.zig_target }}
        run: |
          curl -fL --retry 3 "https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz" | tar xJ -C /opt
          echo "/opt/zig-linux-x86_64-0.13.0" >> "$GITHUB_PATH"
          printf '#!/bin/sh\nexec /opt/zig-linux-x86_64-0.13.0/zig cc -target %s "$@"\n' "$ZIG_TARGET" > /usr/local/bin/zig-cc
          chmod +x /usr/local/bin/zig-cc

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary (static musl)
        working-directory: src
        env:
          CC: ${{ matrix.cc }}
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/${{ matrix.platform }}-musl -lprobe -lm -lunwind"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }} -linkmode external -extldflags \"-static\"" \
            -o ../supervizio-${{ matrix.platform }}-musl ./cmd/daemon

      - name: Verify static binary
        run: |
          file supervizio-${{ matrix.platform }}-musl
          file supervizio-${{ matrix.platform }}-musl | grep -qE "statically linked|static-pie" && \
            echo "OK Binary is statically linked" || \
            echo "WARNING: Binary may not be statically linked"

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.platform }}-musl
          path: supervizio-${{ matrix.platform }}-musl
          retention-days: 1

  # BSD native builds (probe + binary + package on Proxmox VMs)
  build-bsd-native:
    name: BSD ${{ matrix.name }} (native)
    runs-on: [self-hosted, proxmox, linux, x64]
    needs: [version]
    timeout-minutes: 45
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        include:
          - name: freebsd
            vmid: "123"
            vm_ip: "192.168.100.132"
            platform: freebsd-amd64
            pkg_script: setup/packaging/freebsd/build-pkg.sh
            pkg_glob: "supervizio-*.pkg supervizio-*.txz"
          - name: openbsd
            vmid: "120"
            vm_ip: "192.168.100.34"
            platform: openbsd-amd64
            pkg_script: setup/packaging/openbsd/build-pkg.sh
            pkg_glob: "supervizio-*.tgz"
          - name: netbsd
            vmid: "122"
            vm_ip: "192.168.100.199"
            platform: netbsd-amd64
            pkg_script: setup/packaging/netbsd/build-pkg.sh
            pkg_glob: "supervizio-*.tgz"
    env:
      PROXMOX_API_URL: "https://192.168.100.1:8006/api2/json"
      PVE_AUTH: "PVEAPIToken=${{ secrets.CI_RUNNER_API_TOKEN_ID }}=${{ secrets.CI_RUNNER_API_TOKEN_SECRET }}"
      NODE: ${{ secrets.PROXMOX_NODE }}
      SSH_OPTS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Acquire VM (lock)
        id: vm
        run: |
          chmod +x .github/scripts/vm-acquire.sh
          .github/scripts/vm-acquire.sh "${{ matrix.vmid }}" "${GITHUB_RUN_ID}_build-bsd-${{ matrix.name }}" "${{ matrix.vm_ip }}"

      - name: SCP source to VM
        run: |
          tar czf /tmp/src-bundle.tar.gz src/ setup/ examples/
          ssh ${SSH_OPTS} root@${VM_IP} "mkdir -p /root/build"
          scp ${SSH_OPTS} /tmp/src-bundle.tar.gz root@${VM_IP}:/root/build/src-bundle.tar.gz
          ssh ${SSH_OPTS} root@${VM_IP} "cd /root/build && tar xzf src-bundle.tar.gz"

      - name: Log environment (for snapshot tuning)
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'ENV_LOG'
          set -e
          echo "=== Platform Info ==="
          uname -a
          echo ""
          echo "=== Pre-installed Packages ==="
          pkg info 2>/dev/null || pkg_info 2>/dev/null || echo "Package listing not available"
          echo ""
          echo "=== Disk Usage ==="
          df -h
          echo ""
          echo "=== Go Version ==="
          go version 2>/dev/null || echo "Go NOT installed"
          echo ""
          echo "=== Rust Version ==="
          rustc --version 2>/dev/null || echo "Rust NOT installed"
          ENV_LOG

      - name: Install Go and Rust (if needed)
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'INSTALL_DEPS'
          set -e

          # Install Go (exact version from go.dev to ensure consistency)
          GO_VERSION="1.25.6"
          NEED_GO=false
          if ! command -v go >/dev/null 2>&1; then
            NEED_GO=true
          elif ! go version | grep -q "go${GO_VERSION}"; then
            echo "Go version mismatch: $(go version) (need ${GO_VERSION})"
            NEED_GO=true
          fi
          if [ "$NEED_GO" = true ]; then
            echo "=== Installing Go ${GO_VERSION} ==="
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            URL="https://go.dev/dl/go${GO_VERSION}.${OS}-amd64.tar.gz"
            rm -rf /usr/local/go
            case "$OS" in
              freebsd)  fetch -o /tmp/go.tar.gz "$URL" ;;
              *)        ftp -o /tmp/go.tar.gz "$URL" ;;
            esac
            cd /usr/local && tar xzf /tmp/go.tar.gz && rm -f /tmp/go.tar.gz
          fi
          export PATH="/usr/local/go/bin:$HOME/go/bin:$PATH"
          echo "Go: $(go version)"

          # Install Rust if not present
          if ! command -v rustc >/dev/null 2>&1; then
            echo "=== Installing Rust ==="
            if command -v curl >/dev/null 2>&1; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            elif command -v ftp >/dev/null 2>&1; then
              ftp -o /tmp/rustup-init.sh https://sh.rustup.rs
              sh /tmp/rustup-init.sh -y
              rm -f /tmp/rustup-init.sh
            else
              echo "ERROR: No download tool (curl/ftp) available for Rust installation"
              exit 1
            fi
          fi
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "Rust: $(rustc --version)"

          # Install Wire
          echo "=== Installing Wire ==="
          go install github.com/google/wire/cmd/wire@v0.7.0
          echo "Wire: $(wire help 2>&1 | head -1)"
          INSTALL_DEPS

      - name: Configure Rust toolchain for native BSD build
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'OPTIMIZE_RUST'
          set -e
          cd /root/build/src/lib/probe

          # BSD builds are native — no cross-compile targets needed.
          # Use stable channel (tier 3 BSDs may lack specific pinned versions).
          printf '[toolchain]\nchannel = "stable"\n' > rust-toolchain.toml
          cat rust-toolchain.toml
          echo "Using Rust: $(rustc --version 2>/dev/null || echo 'not in PATH yet')"
          OPTIMIZE_RUST

      - name: Build libprobe.a (native)
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'BUILD_PROBE'
          set -e
          export PATH="/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$PATH"

          echo "=== Building libprobe.a natively ==="
          cd /root/build/src/lib/probe
          cargo build --release --package probe-ffi
          PROBE_LIB="$(pwd)/target/release/libprobe.a"
          ls -la "$PROBE_LIB"
          echo "PROBE_LIB=$PROBE_LIB" > /root/build/probe-env.sh
          echo "PROBE_INCLUDE=$(pwd)/include" >> /root/build/probe-env.sh
          echo "=== Probe build complete ==="
          BUILD_PROBE

      - name: Build supervizio binary (native)
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'BUILD_BIN'
          set -e
          export PATH="/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$PATH"
          . /root/build/probe-env.sh

          cd /root/build/src

          echo "=== Generating Wire code ==="
          wire ./internal/bootstrap/

          echo "=== Building supervizio binary ==="
          CGO_ENABLED=1 \
          CGO_CFLAGS="-I${PROBE_INCLUDE}" \
          CGO_LDFLAGS="-L$(dirname ${PROBE_LIB}) -lprobe -lm" \
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o /root/build/supervizio ./cmd/daemon

          echo "=== Binary build complete ==="
          file /root/build/supervizio
          ls -la /root/build/supervizio
          BUILD_BIN

      - name: Probe smoke test
        run: |
          scp ${SSH_OPTS} e2e/probe-capabilities.sh root@${VM_IP}:/root/build/probe-capabilities.sh
          ssh ${SSH_OPTS} root@${VM_IP} << 'PROBE_TEST'
          set -e
          chmod +x /root/build/probe-capabilities.sh
          /root/build/probe-capabilities.sh /root/build/supervizio /root/build/probe-cap.json
          PROBE_TEST

      - name: Retrieve binary artifact
        run: |
          mkdir -p artifacts/bin
          scp ${SSH_OPTS} root@${VM_IP}:/root/build/supervizio \
            artifacts/bin/supervizio-${{ matrix.platform }}
          ls -la artifacts/bin/

      - name: Upload binary artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.platform }}
          path: artifacts/bin/supervizio-${{ matrix.platform }}
          retention-days: 1

      - name: Build native package
        run: |
          # SCP packaging scripts
          tar czf /tmp/pkg-bundle.tar.gz -C "${{ github.workspace }}" setup/packaging/ setup/init/ examples/
          scp ${SSH_OPTS} /tmp/pkg-bundle.tar.gz root@${VM_IP}:/tmp/pkg-bundle.tar.gz
          ssh ${SSH_OPTS} root@${VM_IP} "cd /tmp && tar xzf pkg-bundle.tar.gz"

          ssh ${SSH_OPTS} root@${VM_IP} << 'BUILD_PKG'
          set -e
          echo "=== Building native package ==="
          chmod +x /tmp/${{ matrix.pkg_script }}
          /tmp/${{ matrix.pkg_script }} "${{ needs.version.outputs.version_num }}" "/root/build/supervizio"
          BUILD_PKG

      - name: Retrieve package artifact
        run: |
          mkdir -p artifacts/pkg
          for glob_pattern in ${{ matrix.pkg_glob }}; do
            scp ${SSH_OPTS} "root@${VM_IP}:/tmp/${glob_pattern}" artifacts/pkg/ 2>/dev/null || true
          done
          echo "=== Retrieved packages ==="
          ls -la artifacts/pkg/

      - name: Upload package artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.name }}-pkg
          path: artifacts/pkg/
          retention-days: 1

      - name: Release VM
        if: always()
        run: |
          chmod +x .github/scripts/vm-release.sh
          .github/scripts/vm-release.sh "${{ matrix.vmid }}"

  build-darwin-amd64:
    name: Build darwin-amd64
    runs-on: macos-15-intel
    needs: [version, build-probe-darwin]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-darwin-amd64
          path: dist/lib/darwin-amd64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/darwin-amd64 -lprobe"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o ../supervizio-darwin-amd64 ./cmd/daemon

      - name: Probe smoke test
        run: |
          chmod +x supervizio-darwin-amd64
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-darwin-amd64 probe-cap-darwin-amd64.json

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-darwin-amd64
          path: supervizio-darwin-amd64
          retention-days: 1

  build-darwin-arm64:
    name: Build darwin-arm64
    runs-on: macos-15
    needs: [version, build-probe-darwin-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/darwin-arm64 -lprobe"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=${{ needs.version.outputs.version }}" \
            -o ../supervizio-darwin-arm64 ./cmd/daemon

      - name: Probe smoke test
        run: |
          chmod +x supervizio-darwin-arm64
          chmod +x e2e/probe-capabilities.sh
          e2e/probe-capabilities.sh ./supervizio-darwin-arm64 probe-cap-darwin-arm64.json

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-darwin-arm64
          path: supervizio-darwin-arm64
          retention-days: 1

  # =============================================================================
  # PHASE 3: BUILD PACKAGES
  # =============================================================================

  packages-glibc:
    name: Package ${{ matrix.format }} (${{ matrix.arch }})
    needs: [version, build-linux-amd64, build-linux-arm64]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm]
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-${{ matrix.arch }}

      - name: Prepare binary
        run: chmod +x supervizio-linux-${{ matrix.arch }}

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Import GPG key
        env:
          GPG_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_PASS: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -uo pipefail
          if [ -z "$GPG_KEY" ]; then
            echo "GPG_SIGNING_KEY not set, skipping GPG import"
            exit 0
          fi
          echo "$GPG_KEY" | gpg --batch --import
          if [ -n "$GPG_PASS" ]; then
            echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
            gpg-connect-agent reloadagent /bye
          fi

      - name: Build package
        env:
          VERSION: ${{ needs.version.outputs.version_num }}
          GOARCH: ${{ matrix.arch }}
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager ${{ matrix.format }} --target ./

      - name: Sign DEB package
        if: matrix.format == 'deb'
        continue-on-error: true
        env:
          GPG_KEY: ${{ secrets.GPG_SIGNING_KEY }}
        run: |
          set -uo pipefail
          if [ -z "$GPG_KEY" ]; then
            echo "GPG_SIGNING_KEY not set, skipping DEB signing"
            exit 0
          fi
          if apt-cache show debsigs >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y debsigs
            KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
            for deb in *.deb; do
              [ -f "$deb" ] && debsigs --sign=origin -k "$KEY_ID" "$deb" || echo "debsigs failed for $deb"
            done
          fi

      - name: Sign RPM package
        if: matrix.format == 'rpm'
        continue-on-error: true
        env:
          GPG_KEY: ${{ secrets.GPG_SIGNING_KEY }}
        run: |
          set -uo pipefail
          if [ -z "$GPG_KEY" ]; then
            echo "GPG_SIGNING_KEY not set, skipping RPM signing"
            exit 0
          fi
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "%_gpg_name $KEY_ID" > ~/.rpmmacros
          for rpm in *.rpm; do
            [ -f "$rpm" ] && rpm --addsign "$rpm" 2>/dev/null || echo "RPM signing skipped for $rpm"
          done

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.arch }}.${{ matrix.format }}
          path: "*.${{ matrix.format }}"
          retention-days: 1

  packages-musl:
    name: Package apk (${{ matrix.arch }})
    needs: [version, build-linux-amd64-musl, build-linux-arm64-musl]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-${{ matrix.arch }}-musl

      - name: Prepare binary
        run: |
          # nfpm expects supervizio-linux-{arch}, rename musl version
          mv supervizio-linux-${{ matrix.arch }}-musl supervizio-linux-${{ matrix.arch }}
          chmod +x supervizio-linux-${{ matrix.arch }}

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: ${{ needs.version.outputs.version_num }}
          GOARCH: ${{ matrix.arch }}
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager apk --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.arch }}.apk
          path: "*.apk"
          retention-days: 1

  packages-archlinux:
    name: Package archlinux (amd64)
    needs: [version, build-linux-amd64]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-amd64

      - name: Prepare binary
        run: chmod +x supervizio-linux-amd64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: ${{ needs.version.outputs.version_num }}
          GOARCH: amd64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager archlinux --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-amd64.pkg.tar.zst
          path: "*.pkg.tar.zst"
          retention-days: 1

  packages-xbps:
    name: Package xbps (amd64)
    needs: [version, build-linux-amd64]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-amd64

      - name: Prepare binary
        run: chmod +x supervizio-linux-amd64

      - name: Build xbps package
        run: |
          cat > /tmp/build-xbps.sh << 'XBPS_SCRIPT'
          set -eu
          xbps-create --version

          PKG_DIR="/tmp/supervizio-pkg"
          mkdir -p "${PKG_DIR}/usr/local/bin"
          mkdir -p "${PKG_DIR}/etc/supervizio"
          mkdir -p "${PKG_DIR}/var/log/supervizio"
          mkdir -p "${PKG_DIR}/etc/sv/supervizio"

          cp /workspace/supervizio-linux-amd64 "${PKG_DIR}/usr/local/bin/supervizio"
          chmod 755 "${PKG_DIR}/usr/local/bin/supervizio"

          if [ -f /workspace/examples/config.yaml ]; then
            cp /workspace/examples/config.yaml "${PKG_DIR}/etc/supervizio/config.example.yaml"
          fi

          if [ -d /workspace/setup/init/runit ]; then
            cp -r /workspace/setup/init/runit/* "${PKG_DIR}/etc/sv/supervizio/" 2>/dev/null || true
          fi

          cd /tmp
          xbps-create -A x86_64 \
            -n supervizio-${{ needs.version.outputs.version_num }}_1 \
            -s "PID1-capable process supervisor" \
            -H "https://github.com/supervizio/daemon" \
            -l "MIT" \
            -M "supervizio <noreply@superviz.io>" \
            supervizio-pkg

          ls -la /tmp/supervizio-*.xbps
          cp /tmp/supervizio-${{ needs.version.outputs.version_num }}_1.x86_64.xbps /workspace/supervizio-amd64.xbps
          XBPS_SCRIPT

          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "/tmp/build-xbps.sh:/tmp/build-xbps.sh:ro" \
            -w /workspace \
            ghcr.io/void-linux/void-glibc:latest \
            sh /tmp/build-xbps.sh

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-amd64.xbps
          path: supervizio-amd64.xbps
          retention-days: 1

  # =============================================================================
  # PHASE 4: E2E TESTS
  # =============================================================================

  e2e-docker:
    name: E2E Docker ${{ matrix.name }}
    needs: [version, build-linux-amd64, build-linux-amd64-musl]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: debian-glibc
            dockerfile: Dockerfile.debian-script
            artifact: supervizio-linux-amd64
            description: "Debian with glibc (systemd)"
          - name: alpine-musl
            dockerfile: Dockerfile.alpine-script
            artifact: supervizio-linux-amd64-musl
            description: "Alpine with musl (OpenRC)"
          - name: scratch
            dockerfile: Dockerfile.scratch
            artifact: supervizio-linux-amd64-musl
            description: "Scratch (static binary, no OS)"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Prepare binary
        run: |
          ls -la bin/
          chmod +x bin/${{ matrix.artifact }}
          # Dockerfile.scratch expects bin/supervizio, others expect bin/supervizio-linux-amd64
          if [ "${{ matrix.dockerfile }}" = "Dockerfile.scratch" ]; then
            mv bin/${{ matrix.artifact }} bin/supervizio
          elif [ "${{ matrix.artifact }}" != "supervizio-linux-amd64" ]; then
            mv bin/${{ matrix.artifact }} bin/supervizio-linux-amd64
          fi
          file bin/supervizio* | head -5

      - name: Build container
        run: |
          docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-e2e:${{ matrix.name }}-amd64 .

      - name: Test container startup
        run: |
          docker run --rm supervizio-e2e:${{ matrix.name }}-amd64

      - name: Validate probe metrics
        if: matrix.dockerfile != 'Dockerfile.scratch'
        run: |
          docker run --rm --entrypoint sh supervizio-e2e:${{ matrix.name }}-amd64 -c "
            set -e
            echo '=== System Info ==='
            uname -a
            cat /etc/os-release 2>/dev/null || true

            echo ''
            echo '=== Running --probe ==='
            OUTPUT=\$(/usr/local/bin/supervizio --probe 2>&1) || {
              echo 'ERROR: --probe failed'
              echo \"Output: \$OUTPUT\"
              exit 1
            }

            echo 'Raw JSON:'
            echo \"\$OUTPUT\"

            echo ''
            echo '=== Validation ==='
            echo \"\$OUTPUT\" | jq -e '.timestamp' > /dev/null && echo 'OK timestamp'
            echo \"\$OUTPUT\" | jq -e '.platform' > /dev/null && echo 'OK platform'
            echo \"\$OUTPUT\" | jq -r '.cpu.cores // \"null\"' | xargs -I {} echo 'cpu.cores = {}'

            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
              echo 'OK Probe validation passed: ${{ matrix.description }}'
          "

      - name: Test scratch container (no shell)
        if: matrix.dockerfile == 'Dockerfile.scratch'
        run: |
          echo "=== Testing scratch container (static binary, no OS) ==="

          echo "--- Test --version ---"
          docker run --rm supervizio-e2e:scratch-amd64 --version
          echo "OK --version works"

          echo ""
          echo "--- Test --probe ---"
          OUTPUT=$(docker run --rm supervizio-e2e:scratch-amd64 --probe 2>&1) || {
            echo "ERROR: --probe failed"
            echo "Output: $OUTPUT"
            exit 1
          }
          echo "Probe output:"
          echo "$OUTPUT"

          # Validate JSON structure
          echo ""
          echo "--- Validate JSON ---"
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "OK timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "OK platform present"
          echo "$OUTPUT" | jq -e '.cpu.cores > 0' > /dev/null && echo "OK cpu.cores > 0"
          echo "$OUTPUT" | jq -e '.memory.total_bytes > 0' > /dev/null && echo "OK memory.total_bytes > 0"

          echo ""
          echo "OK Scratch container tests passed"

  e2e-docker-arm64:
    name: E2E Docker arm64 ${{ matrix.name }}
    needs: [version, build-linux-arm64, build-linux-arm64-musl]
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: debian-glibc
            dockerfile: Dockerfile.debian-script
            artifact: supervizio-linux-arm64
            binary_name: supervizio-linux-amd64
            description: "Debian ARM64 with glibc (systemd)"
          - name: alpine-musl
            dockerfile: Dockerfile.alpine-script
            artifact: supervizio-linux-arm64-musl
            binary_name: supervizio-linux-amd64
            description: "Alpine ARM64 with musl (OpenRC)"
          - name: scratch
            dockerfile: Dockerfile.scratch
            artifact: supervizio-linux-arm64-musl
            binary_name: supervizio
            description: "Scratch ARM64 (static binary, no OS)"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Prepare binary
        run: |
          ls -la bin/
          chmod +x bin/${{ matrix.artifact }}
          # Dockerfiles expect amd64 binary names — rename arm64 to match
          mv bin/${{ matrix.artifact }} bin/${{ matrix.binary_name }}
          file bin/${{ matrix.binary_name }}

      - name: Build container
        run: |
          docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-e2e:${{ matrix.name }}-arm64 .

      - name: Test container startup
        run: |
          docker run --rm supervizio-e2e:${{ matrix.name }}-arm64

      - name: Validate probe metrics
        if: matrix.dockerfile != 'Dockerfile.scratch'
        run: |
          docker run --rm --entrypoint sh supervizio-e2e:${{ matrix.name }}-arm64 -c "
            set -e
            echo '=== System Info ==='
            uname -a
            cat /etc/os-release 2>/dev/null || true

            echo ''
            echo '=== Running --probe ==='
            OUTPUT=\$(/usr/local/bin/supervizio --probe 2>&1) || {
              echo 'ERROR: --probe failed'
              echo \"Output: \$OUTPUT\"
              exit 1
            }

            echo 'Raw JSON:'
            echo \"\$OUTPUT\"

            echo ''
            echo '=== Validation ==='
            echo \"\$OUTPUT\" | jq -e '.timestamp' > /dev/null && echo 'OK timestamp'
            echo \"\$OUTPUT\" | jq -e '.platform' > /dev/null && echo 'OK platform'
            echo \"\$OUTPUT\" | jq -r '.cpu.cores // \"null\"' | xargs -I {} echo 'cpu.cores = {}'

            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
              echo 'OK Probe validation passed: ${{ matrix.description }}'
          "

      - name: Test scratch container (no shell)
        if: matrix.dockerfile == 'Dockerfile.scratch'
        run: |
          echo "=== Testing scratch container (static binary, no OS) ==="

          echo "--- Test --version ---"
          docker run --rm supervizio-e2e:scratch-arm64 --version
          echo "OK --version works"

          echo ""
          echo "--- Test --probe ---"
          OUTPUT=$(docker run --rm supervizio-e2e:scratch-arm64 --probe 2>&1) || {
            echo "ERROR: --probe failed"
            echo "Output: $OUTPUT"
            exit 1
          }
          echo "Probe output:"
          echo "$OUTPUT"

          echo ""
          echo "--- Validate JSON ---"
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "OK timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "OK platform present"
          echo "$OUTPUT" | jq -e '.cpu.cores > 0' > /dev/null && echo "OK cpu.cores > 0"
          echo "$OUTPUT" | jq -e '.memory.total_bytes > 0' > /dev/null && echo "OK memory.total_bytes > 0"

          echo ""
          echo "OK Scratch ARM64 container tests passed"

  e2e-macos:
    name: E2E macOS x86_64
    needs: [version, build-darwin-amd64]
    runs-on: macos-15-intel
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-darwin-amd64
          path: bin

      - name: Prepare binary
        run: |
          chmod +x bin/supervizio-darwin-amd64
          file bin/supervizio-darwin-amd64

      - name: Run macOS E2E test
        run: |
          set -euo pipefail
          export PATH="$PWD/bin:$PATH"
          mv bin/supervizio-darwin-amd64 bin/supervizio
          chmod +x bin/supervizio

          echo "=== System Info ==="
          uname -a
          sysctl hw.ncpu || true
          sw_vers || true

          echo ""
          echo "=== Test version ==="
          bin/supervizio --version

          echo ""
          echo "=== Test probe ==="
          OUTPUT=$(bin/supervizio --probe 2>&1) || {
            echo "ERROR: --probe command failed with exit code $?"
            echo "Output: $OUTPUT"
            exit 1
          }

          echo "Raw JSON output:"
          echo "$OUTPUT"

          echo ""
          echo "=== Validate JSON structure ==="
          echo "$OUTPUT" | jq -e 'type == "object"' > /dev/null || {
            echo "ERROR: Output is not valid JSON object"
            exit 1
          }

          echo "Checking required fields..."
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "OK timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "OK platform present"
          echo "$OUTPUT" | jq -e '.cpu' > /dev/null && echo "OK cpu present" || echo "FAIL cpu MISSING"
          echo "$OUTPUT" | jq -r '.cpu.cores // "null"' | xargs -I {} echo "  cpu.cores = {}"

          echo ""
          echo "=== Final validation ==="
          echo "$OUTPUT" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
            echo "OK Probe validation passed on macOS x86_64"

  e2e-macos-arm64:
    name: E2E macOS ARM64
    needs: [version, build-darwin-arm64]
    runs-on: macos-15
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-darwin-arm64
          path: bin

      - name: Prepare binary
        run: |
          chmod +x bin/supervizio-darwin-arm64
          file bin/supervizio-darwin-arm64

      - name: Run macOS ARM64 E2E test
        run: |
          set -euo pipefail
          export PATH="$PWD/bin:$PATH"
          mv bin/supervizio-darwin-arm64 bin/supervizio
          chmod +x bin/supervizio

          echo "=== System Info ==="
          uname -a
          sysctl hw.ncpu || true
          sw_vers || true

          echo ""
          echo "=== Test version ==="
          bin/supervizio --version

          echo ""
          echo "=== Test probe ==="
          OUTPUT=$(bin/supervizio --probe 2>&1) || {
            echo "ERROR: --probe command failed with exit code $?"
            echo "Output: $OUTPUT"
            exit 1
          }

          echo "Raw JSON output:"
          echo "$OUTPUT"

          echo ""
          echo "=== Validate JSON structure ==="
          echo "$OUTPUT" | jq -e 'type == "object"' > /dev/null || {
            echo "ERROR: Output is not valid JSON object"
            exit 1
          }

          echo "Checking required fields..."
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "OK timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "OK platform present"
          echo "$OUTPUT" | jq -e '.cpu' > /dev/null && echo "OK cpu present" || echo "FAIL cpu MISSING"
          echo "$OUTPUT" | jq -r '.cpu.cores // "null"' | xargs -I {} echo "  cpu.cores = {}"

          echo ""
          echo "=== Final validation ==="
          echo "$OUTPUT" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
            echo "OK Probe validation passed on macOS ARM64"

  # E2E VM tests (Proxmox, self-hosted) — same matrix as CI
  e2e-vm:
    name: E2E VM ${{ matrix.name }}
    runs-on: [self-hosted, proxmox, linux, x64]
    needs: [version, packages-glibc, packages-musl, packages-archlinux, packages-xbps, build-bsd-native]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          - name: alpine-openrc
            vmid: "117"
            binary_artifact: supervizio-linux-amd64-musl
            pkg_artifact: supervizio-amd64.apk
            pkg_ext: apk
          - name: alpine-s6
            vmid: "118"
            binary_artifact: supervizio-linux-amd64-musl
            pkg_artifact: supervizio-amd64.apk
            pkg_ext: apk
          - name: arch-systemd
            vmid: "116"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.pkg.tar.zst
            pkg_ext: pkg.tar.zst
          - name: artix-dinit
            vmid: "128"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.pkg.tar.zst
            pkg_ext: pkg.tar.zst
          - name: debian-systemd
            vmid: "121"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.deb
            pkg_ext: deb
          - name: devuan-sysvinit
            vmid: "115"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.deb
            pkg_ext: deb
          - name: fedora-systemd
            vmid: "114"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.rpm
            pkg_ext: rpm
          - name: opensuse-systemd
            vmid: "119"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.rpm
            pkg_ext: rpm
          - name: void-runit
            vmid: "113"
            binary_artifact: supervizio-linux-amd64
            pkg_artifact: supervizio-amd64.xbps
            pkg_ext: xbps
          - name: freebsd
            vmid: "123"
            vm_ip: "192.168.100.132"
            binary_artifact: supervizio-freebsd-amd64
            pkg_artifact: ""
            pkg_ext: ""
          - name: openbsd
            vmid: "120"
            vm_ip: "192.168.100.34"
            binary_artifact: supervizio-openbsd-amd64
            pkg_artifact: ""
            pkg_ext: ""
          - name: netbsd
            vmid: "122"
            vm_ip: "192.168.100.199"
            binary_artifact: supervizio-netbsd-amd64
            pkg_artifact: ""
            pkg_ext: ""
    env:
      PROXMOX_API_URL: "https://192.168.100.1:8006/api2/json"
      PVE_AUTH: "PVEAPIToken=${{ secrets.CI_RUNNER_API_TOKEN_ID }}=${{ secrets.CI_RUNNER_API_TOKEN_SECRET }}"
      NODE: ${{ secrets.PROXMOX_NODE }}
      SSH_OPTS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download package artifact
        if: matrix.pkg_artifact != ''
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        continue-on-error: true
        id: download-pkg
        with:
          name: ${{ matrix.pkg_artifact }}
          path: artifacts/

      - name: Download binary artifact (fallback)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        continue-on-error: true
        id: download-bin
        with:
          name: ${{ matrix.binary_artifact }}
          path: artifacts/

      - name: Prepare artifacts
        run: |
          echo "=== Available artifacts ==="
          ls -la artifacts/ 2>/dev/null || echo "No artifacts found"

          # Find the package or binary to deploy
          if [ -n "${{ matrix.pkg_ext }}" ]; then
            PKG_FILE=$(find artifacts/ -name "*.${{ matrix.pkg_ext }}" 2>/dev/null | head -1)
            if [ -n "$PKG_FILE" ]; then
              echo "PKG_FILE=$PKG_FILE" >> "$GITHUB_ENV"
              echo "DEPLOY_MODE=package" >> "$GITHUB_ENV"
              echo "Found package: $PKG_FILE"
            else
              echo "Package not found, falling back to binary"
              echo "DEPLOY_MODE=binary" >> "$GITHUB_ENV"
            fi
          else
            echo "DEPLOY_MODE=binary" >> "$GITHUB_ENV"
          fi

          # Find binary
          BIN_FILE=$(find artifacts/ -name "supervizio-*" -not -name "*.deb" -not -name "*.rpm" -not -name "*.apk" -not -name "*.pkg.tar.zst" -not -name "*.xbps" 2>/dev/null | head -1)
          if [ -n "$BIN_FILE" ]; then
            chmod +x "$BIN_FILE"
            echo "BIN_FILE=$BIN_FILE" >> "$GITHUB_ENV"
            echo "Found binary: $BIN_FILE"
          fi

      - name: Acquire VM (lock)
        id: vm
        run: |
          chmod +x .github/scripts/vm-acquire.sh
          .github/scripts/vm-acquire.sh "${{ matrix.vmid }}" "${GITHUB_RUN_ID}_e2e-vm-${{ matrix.name }}" "${{ matrix.vm_ip }}"

      - name: SCP files to VM
        run: |
          # Retry helper for transient SSH/SCP failures
          retry() {
            local n=0 max=3
            while [ $n -lt $max ]; do
              "$@" && return 0
              n=$((n + 1))
              echo "Retry $n/$max..."
              sleep 5
            done
            echo "Failed after $max attempts: $*"
            return 1
          }

          # Use -O (legacy SCP protocol) for VMs without SFTP subsystem
          SCP_CMD="scp -O ${SSH_OPTS}"

          # Clean previous files to prevent SCP nesting issues
          ssh ${SSH_OPTS} root@${VM_IP} "rm -rf /tmp/setup /tmp/validate-probe.sh /tmp/supervizio*" || true

          # Copy setup scripts
          retry ${SCP_CMD} -r setup root@${VM_IP}:/tmp/setup

          # Copy test scripts
          retry ${SCP_CMD} e2e/validate-probe.sh root@${VM_IP}:/tmp/validate-probe.sh

          # Copy package if available
          if [ "$DEPLOY_MODE" = "package" ] && [ -n "${PKG_FILE:-}" ]; then
            retry ${SCP_CMD} "$PKG_FILE" root@${VM_IP}:/tmp/supervizio.${{ matrix.pkg_ext }}
            echo "Copied package: $PKG_FILE"
          fi

          # Always copy binary as fallback
          if [ -n "${BIN_FILE:-}" ]; then
            retry ${SCP_CMD} "$BIN_FILE" root@${VM_IP}:/tmp/supervizio
            ssh ${SSH_OPTS} root@${VM_IP} "chmod +x /tmp/supervizio"
            echo "Copied binary: $BIN_FILE"
          fi

          # Fail if nothing was copied
          if [ -z "${PKG_FILE:-}" ] && [ -z "${BIN_FILE:-}" ]; then
            echo "ERROR: No package or binary to deploy"
            exit 1
          fi

      - name: Install jq (best-effort)
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'INSTALL_JQ'
          # Try to install jq - varies by OS
          # Verify jq actually works (not just exists — some VMs have empty binaries)
          if command -v jq >/dev/null 2>&1 && echo '{}' | jq . >/dev/null 2>&1; then
            echo "jq already available and functional"
            exit 0
          fi
          # Remove broken jq if present but non-functional
          if command -v jq >/dev/null 2>&1; then
            echo "jq exists but broken, forcing reinstall"
            rm -f "$(command -v jq)" 2>/dev/null || true
          fi
          # Try common package managers (each with functional verification)
          apk add --no-cache jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          apt-get update -qq && apt-get install -y -qq jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          dnf install -y jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          yum install -y jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          zypper install -y jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          pacman -Sy --noconfirm jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          xbps-install -Sy jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          pkg install -y jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          pkg_add jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          pkgin -y install jq 2>/dev/null && echo '{}' | jq . >/dev/null 2>&1 && exit 0
          # Static binary fallback (works on any Linux/BSD x86_64/arm64)
          echo "Package jq install failed or broken, trying static binary..."
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64|amd64) JQ_ARCH="amd64" ;;
            aarch64|arm64) JQ_ARCH="arm64" ;;
            *) JQ_ARCH="" ;;
          esac
          if [ -n "$JQ_ARCH" ]; then
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            case "$OS" in
              freebsd) OS="linux" ;; # jq linux static works on FreeBSD via compat
              *) ;;
            esac
            JQ_URL="https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-${OS}-${JQ_ARCH}"
            curl -fsSL "$JQ_URL" -o /usr/local/bin/jq 2>/dev/null || \
              fetch -o /usr/local/bin/jq "$JQ_URL" 2>/dev/null || \
              ftp -o /usr/local/bin/jq "$JQ_URL" 2>/dev/null || true
            chmod +x /usr/local/bin/jq 2>/dev/null
            if echo '{}' | /usr/local/bin/jq . >/dev/null 2>&1; then
              echo "Static jq installed successfully"
              exit 0
            fi
          fi
          echo "WARNING: Could not install functional jq"
          exit 0
          INSTALL_JQ

      - name: Install supervizio
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'INSTALL_CMD'
          set -e
          echo "=== Platform Info ==="
          uname -a
          echo ""

          # Set package source if available
          if [ -f "/tmp/supervizio.${{ matrix.pkg_ext }}" ] && [ -n "${{ matrix.pkg_ext }}" ]; then
            echo "Package available: /tmp/supervizio.${{ matrix.pkg_ext }}"
            export SUPERVIZIO_LOCAL_PKG="/tmp/supervizio.${{ matrix.pkg_ext }}"
          fi

          # Set binary fallback if available
          if [ -f "/tmp/supervizio" ]; then
            echo "Binary available: /tmp/supervizio"
            export SUPERVIZIO_LOCAL_BIN="/tmp/supervizio"
          fi

          if [ -z "${SUPERVIZIO_LOCAL_PKG:-}" ] && [ -z "${SUPERVIZIO_LOCAL_BIN:-}" ]; then
            echo "ERROR: No package or binary found"
            exit 1
          fi

          chmod +x /tmp/setup/install.sh
          /tmp/setup/install.sh
          INSTALL_CMD

      - name: Verify installation
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'VERIFY_CMD'
          set -e
          echo "=== Verify Installation ==="

          # Check binary exists
          if [ -f /usr/local/bin/supervizio ]; then
            echo "OK Binary found at /usr/local/bin/supervizio"
          else
            echo "FAIL Binary NOT found"
            exit 1
          fi

          # Check config directory
          if [ -d /etc/supervizio ]; then
            echo "OK Config directory exists"
          else
            echo "SKIP Config directory not found (may be OK for BSD)"
          fi

          # Check version
          echo ""
          echo "=== Version ==="
          /usr/local/bin/supervizio --version || echo "version check done"
          VERIFY_CMD

      - name: Validate probe
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'PROBE_CMD'
          set -e
          if command -v jq >/dev/null 2>&1; then
            chmod +x /tmp/validate-probe.sh
            /tmp/validate-probe.sh
          else
            echo "[WARN] jq not available, running basic probe test"
            OUTPUT=$(/usr/local/bin/supervizio --probe 2>&1) || {
              echo "ERROR: --probe failed"
              echo "Output: $OUTPUT"
              exit 1
            }
            echo "Probe output:"
            echo "$OUTPUT"
            echo "OK Probe returned output (jq not available for validation)"
          fi
          PROBE_CMD

      - name: Uninstall supervizio
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'UNINSTALL_CMD'
          set -e
          echo "=== Uninstalling supervizio ==="
          export SUPERVIZIO_NON_INTERACTIVE=true
          chmod +x /tmp/setup/uninstall.sh
          /tmp/setup/uninstall.sh
          UNINSTALL_CMD

      - name: Verify clean uninstall
        run: |
          ssh ${SSH_OPTS} root@${VM_IP} << 'VERIFY_CLEAN'
          set -e
          echo "=== Verify Clean Uninstall ==="
          ERRORS=0

          # Check binary removed
          if [ -f /usr/local/bin/supervizio ]; then
            echo "FAIL Binary still present!"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK Binary removed"
          fi

          # Check service files removed
          for svc in /etc/systemd/system/supervizio.service \
                     /usr/lib/systemd/system/supervizio.service \
                     /etc/init.d/supervizio \
                     /etc/sv/supervizio/run \
                     /etc/s6/supervizio/run \
                     /etc/dinit.d/supervizio \
                     /etc/rc.d/supervizio; do
            if [ -f "$svc" ]; then
              echo "FAIL Service file still present: $svc"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "WARNING: $ERRORS items not cleaned up"
          else
            echo "OK Clean uninstall verified"
          fi
          VERIFY_CLEAN

      - name: Release VM
        if: always()
        run: |
          chmod +x .github/scripts/vm-release.sh
          .github/scripts/vm-release.sh "${{ matrix.vmid }}"

  # =============================================================================
  # VM CLEANUP (always runs after E2E VM)
  # =============================================================================

  vm-cleanup:
    name: VM Cleanup
    runs-on: [self-hosted, proxmox, linux, x64]
    needs: [e2e-vm]
    if: always()
    timeout-minutes: 10
    env:
      PROXMOX_API_URL: "https://192.168.100.1:8006/api2/json"
      PVE_AUTH: "PVEAPIToken=${{ secrets.CI_RUNNER_API_TOKEN_ID }}=${{ secrets.CI_RUNNER_API_TOKEN_SECRET }}"
      NODE: ${{ secrets.PROXMOX_NODE }}
    steps:
      - name: Reset all VMs to base snapshot
        run: |
          echo "=== VM Cleanup: Resetting all VMs to base snapshot ==="

          # Validate Proxmox credentials
          if [ -z "$NODE" ] || [ "$PVE_AUTH" = "PVEAPIToken==" ]; then
            echo "WARNING: Proxmox secrets not configured, skipping VM cleanup"
            exit 0
          fi

          VMIDS=(113 114 115 116 117 118 119 120 121 122 123 128)
          FAILED=0

          for VMID in "${VMIDS[@]}"; do
            echo ""
            echo "--- VM ${VMID} ---"

            echo "  Stopping VM ${VMID}..."
            curl -sf -k -H "Authorization: ${PVE_AUTH}" \
              -X POST "${PROXMOX_API_URL}/nodes/${NODE}/qemu/${VMID}/status/stop" 2>/dev/null || true
            sleep 5

            echo "  Rolling back to 'base' snapshot..."
            if curl -sf -k -H "Authorization: ${PVE_AUTH}" \
              -X POST "${PROXMOX_API_URL}/nodes/${NODE}/qemu/${VMID}/snapshot/base/rollback" 2>/dev/null; then
              echo "  VM ${VMID} reset to base"
            else
              echo "  WARNING: Failed to rollback VM ${VMID}"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "=== VM Cleanup Complete ==="
          echo "  Total VMs: ${#VMIDS[@]}"
          echo "  Failed: ${FAILED}"

          if [ "$FAILED" -gt 0 ]; then
            echo "  WARNING: Some VMs failed to reset (non-fatal)"
          fi

  # =============================================================================
  # CREATE RELEASE (atomic: draft → upload → publish)
  # =============================================================================
  release:
    name: Release
    needs:
      - version
      - build-linux-amd64
      - build-linux-amd64-musl
      - build-linux-arm64
      - build-linux-arm64-musl
      - build-linux-cross
      - build-linux-cross-musl
      - build-bsd-native
      - build-darwin-amd64
      - build-darwin-arm64
      - packages-glibc
      - packages-musl
      - packages-archlinux
      - packages-xbps
      - e2e-docker
      - e2e-docker-arm64
      - e2e-macos
      - e2e-macos-arm64
      - e2e-vm
    runs-on: ubuntu-24.04
    outputs:
      release_created: ${{ steps.publish.outputs.release_created }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          set -euo pipefail
          mkdir -p release
          cd artifacts
          for dir in */; do
            for file in "$dir"*; do
              [ -f "$file" ] || continue
              filename=$(basename "$file")
              mv "$file" ../release/
              (cd ../release && sha256sum "$filename" >> checksums.txt)
            done
          done
          echo "=== Checksums ===" && cat ../release/checksums.txt

      - name: Generate release notes
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -euo pipefail
          cat > release-notes.md << 'EOF'
          ## superviz.io ${{ needs.version.outputs.version }}

          PID1-capable process supervisor for containers and Unix systems.

          ### Platforms (all with probe)

          | OS | amd64 | arm64 | arm | 386 | riscv64 | Build |
          |----|:-----:|:-----:|:---:|:---:|:-------:|-------|
          | Linux (glibc) | :white_check_mark: | :white_check_mark: | :white_check_mark: | :white_check_mark: | :white_check_mark: | Native + Cross, CGO_ENABLED=1 |
          | Linux (musl) | :white_check_mark: | :white_check_mark: | :white_check_mark: | :white_check_mark: | :white_check_mark: | Static, CGO_ENABLED=1 |
          | FreeBSD | :white_check_mark: | — | — | — | — | Native VM |
          | OpenBSD | :white_check_mark: | — | — | — | — | Native VM |
          | NetBSD | :white_check_mark: | — | — | — | — | Native VM |
          | macOS | :white_check_mark: | :white_check_mark: | — | — | — | Native |

          ### E2E Tested (12 VMs)

          | Init System | Distribution | Status |
          |-------------|--------------|:------:|
          | systemd | Debian, Fedora, openSUSE, Arch | :white_check_mark: |
          | OpenRC | Alpine | :white_check_mark: |
          | s6 | Alpine | :white_check_mark: |
          | dinit | Artix | :white_check_mark: |
          | SysVinit | Devuan | :white_check_mark: |
          | runit | Void | :white_check_mark: |
          | BSD rc.d | FreeBSD, OpenBSD, NetBSD | :white_check_mark: |

          ### Linux Packages

          | Format | Architectures | Distributions |
          |--------|---------------|---------------|
          | `.deb` | amd64, arm64 | Debian, Devuan, Ubuntu |
          | `.rpm` | amd64, arm64 | Fedora, RHEL, openSUSE |
          | `.apk` | amd64, arm64 | Alpine |
          | `.pkg.tar.zst` | amd64 | Arch, Artix |
          | `.xbps` | amd64 | Void |

          ### BSD Packages

          | Format | Distribution |
          |--------|--------------|
          | `.pkg` / `.txz` | FreeBSD |
          | `.tgz` | OpenBSD |
          | `.tgz` | NetBSD |

          ### Musl Static Binaries

          Use `supervizio-linux-{arch}-musl` for Alpine Linux / scratch containers:
          - `supervizio-linux-amd64-musl`, `supervizio-linux-arm64-musl`
          - `supervizio-linux-arm-musl`, `supervizio-linux-386-musl`, `supervizio-linux-riscv64-musl`
          - Fully static, no external dependencies

          ### Binary Install (all platforms)

          ```bash
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')
          curl -fsSL "https://github.com/${{ github.repository }}/releases/download/${{ needs.version.outputs.version }}/supervizio-${OS}-${ARCH}" -o supervizio
          chmod +x supervizio && sudo mv supervizio /usr/local/bin/
          ```

          ### Checksums (SHA256)
          ```
          EOF
          cat release/checksums.txt >> release-notes.md
          echo '```' >> release-notes.md

      - name: Create tag (if needed)
        if: needs.version.outputs.is_new_tag == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.version.outputs.version }}" -m "Release ${{ needs.version.outputs.version }}"
          git push origin "${{ needs.version.outputs.version }}"

      - name: Create draft release
        id: draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -euo pipefail
          echo "Creating draft release for $VERSION..."

          PRERELEASE_FLAG=""
          if [[ "$VERSION" == *-* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$VERSION" \
            --draft \
            --title "superviz.io $VERSION" \
            --notes-file release-notes.md \
            $PRERELEASE_FLAG

          echo "Draft release created successfully"

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -euo pipefail
          echo "Uploading assets to draft release..."

          for file in release/*; do
            [ -f "$file" ] || continue
            echo "Uploading: $(basename "$file")"
            gh release upload "$VERSION" "$file" --clobber
          done

          echo "All assets uploaded successfully"

      - name: Publish release (remove draft)
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -euo pipefail
          echo "Publishing release (removing draft status)..."

          gh release edit "$VERSION" --draft=false

          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "Release $VERSION published successfully!"

  # =============================================================================
  # Cleanup on Failure (safe: only delete draft releases)
  # =============================================================================
  cleanup-on-failure:
    name: Cleanup Failed Release
    needs: [version, e2e-docker, e2e-docker-arm64, e2e-macos, e2e-macos-arm64, e2e-vm]
    if: failure() && needs.version.outputs.is_new_tag == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Safe cleanup (draft releases only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -uo pipefail
          echo "=== Safe Cleanup for $VERSION ==="
          echo "E2E tests failed. Checking release state..."

          # Check if release exists and get its status
          RELEASE_INFO=$(gh release view "$VERSION" --json isDraft,tagName 2>/dev/null || echo "NOT_FOUND")

          if [ "$RELEASE_INFO" = "NOT_FOUND" ]; then
            echo "No release found for $VERSION. Checking tag..."

            # Only delete tag if it was created by this workflow (is_new_tag=true)
            if git ls-remote --tags origin | grep -q "refs/tags/$VERSION"; then
              echo "Tag $VERSION exists. Since is_new_tag=true, deleting tag created by this workflow..."
              git push origin --delete "$VERSION" || echo "Tag deletion failed"
            else
              echo "Tag $VERSION does not exist remotely. Nothing to delete."
            fi
          else
            # Release exists - check if it's a draft
            IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft')

            if [ "$IS_DRAFT" = "true" ]; then
              echo "Release $VERSION is a DRAFT. Safe to delete."
              gh release delete "$VERSION" --yes || echo "Release deletion failed"

              # Also delete the tag since the release was never published
              if git ls-remote --tags origin | grep -q "refs/tags/$VERSION"; then
                echo "Deleting associated tag..."
                git push origin --delete "$VERSION" || echo "Tag deletion failed"
              fi
            else
              echo "SAFETY CHECK: Release $VERSION is NOT a draft (isDraft=$IS_DRAFT)."
              echo "Refusing to delete a published release. Manual intervention required."
              echo "::warning::Release $VERSION exists and is published. Not deleting."
            fi
          fi

          echo "=== Cleanup complete ==="
