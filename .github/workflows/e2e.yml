# =============================================================================
# E2E Tests - Linux VM Testing with KVM
# =============================================================================
# Tests supervizio on Linux VMs with KVM acceleration:
# - AMD64: ubuntu-latest (KVM available)
# - ARM64: ubuntu-24.04-arm (native ARM64)
#
# Each job tests:
# 1. VM: Debian via Vagrant + libvirt/KVM (installation test)
# 2. Container: Debian via Docker (entrypoint test)
#
# Matrix: 2 jobs (1 AMD64 + 1 ARM64)
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # AMD64 E2E Tests (Ubuntu with KVM)
  # ===========================================================================
  e2e-amd64:
    name: E2E AMD64 (Debian VM + Container)
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/amd64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test: Debian via Vagrant + libvirt/KVM
      # =========================================================================
      - name: Setup KVM
        run: |
          echo "=== Checking KVM availability ==="
          if [ -e /dev/kvm ]; then
            echo "KVM device found, configuring permissions..."
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            ls -la /dev/kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "WARNING: /dev/kvm not found - VM tests will use QEMU TCG (slower)"
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Install libvirt and dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            qemu-system-arm \
            ebtables \
            ruby-dev \
            ruby-libvirt \
            build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-debian-libvirt-amd64-v1

      - name: Start Debian VM
        working-directory: e2e
        run: |
          echo "=== Starting Debian VM (AMD64 with KVM) ==="
          sudo -E vagrant up debian --provider=libvirt
          echo "=== VM started ==="

      - name: Run VM installation test
        working-directory: e2e
        run: |
          echo "=== Running installation tests ==="
          sudo -E vagrant ssh debian -c "sudo /vagrant/test-install.sh"
          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: sudo vagrant destroy debian -f 2>/dev/null || true

      # =========================================================================
      # Container Test: Debian via Docker
      # =========================================================================
      - name: Build Debian container (amd64)
        run: |
          docker build \
            -f e2e/Dockerfile.debian \
            -t supervizio-debian:amd64 .
          echo "=== Image info ==="
          docker images supervizio-debian:amd64

      - name: Test Debian container (amd64)
        run: |
          echo "=== Testing supervizio in Debian container (amd64) ==="
          docker run --rm supervizio-debian:amd64
          echo "=== Container test passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Docker Images ==="
          docker images || true

  # ===========================================================================
  # ARM64 E2E Tests (Ubuntu ARM64) - VM + Container
  # Note: Using virt-install + cloud-init (Vagrant not available for ARM64 Linux)
  # See: https://github.com/hashicorp/vagrant-installers/issues/288
  # ===========================================================================
  e2e-arm64:
    name: E2E ARM64 (Debian VM + Container)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 35  # Extra time for QEMU TCG if KVM unavailable
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/arm64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test: Debian via virt-install + cloud-init (no Vagrant for ARM64 Linux)
      # =========================================================================
      - name: Setup KVM
        run: |
          echo "=== Checking KVM availability ==="
          if [ -e /dev/kvm ]; then
            echo "KVM device found, configuring permissions..."
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            ls -la /dev/kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "WARNING: /dev/kvm not found - VM tests will use QEMU TCG (slower)"
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Install libvirt and virt-install
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-clients \
            virtinst \
            qemu-kvm \
            qemu-system-arm \
            qemu-efi-aarch64 \
            cloud-image-utils \
            genisoimage \
            sshpass
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Start default network (required for VMs)
          sudo virsh net-start default 2>/dev/null || true
          sudo virsh net-autostart default 2>/dev/null || true

          # Check UEFI firmware availability
          echo "=== UEFI Firmware Check ==="
          ls -la /usr/share/AAVMF/ 2>/dev/null || echo "AAVMF not found"
          ls -la /usr/share/qemu-efi-aarch64/ 2>/dev/null || echo "qemu-efi-aarch64 not found"

      - name: Cache Debian cloud image
        uses: actions/cache@v4
        with:
          path: /tmp/debian-12-generic-arm64.qcow2
          key: debian12-cloud-arm64-v1

      - name: Download Debian ARM64 cloud image
        run: |
          if [ ! -f /tmp/debian-12-generic-arm64.qcow2 ]; then
            echo "=== Downloading Debian 12 ARM64 cloud image ==="
            wget -q -O /tmp/debian-12-generic-arm64.qcow2 \
              https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-arm64.qcow2
          fi
          ls -lh /tmp/debian-12-generic-arm64.qcow2

      - name: Check KVM availability for VM tests
        run: |
          if [ "$KVM_AVAILABLE" != "true" ]; then
            echo "::notice::KVM not available - using QEMU TCG (software emulation)"
            echo "Boot will be slower but VM tests will still run"
          else
            echo "KVM available - using hardware acceleration"
          fi

      - name: Create cloud-init configuration
        run: |
          mkdir -p /tmp/cloud-init

          # Create user-data (YAML - indentation matters!)
          cat > /tmp/cloud-init/user-data << 'USERDATA'
          #cloud-config
          users:
            - name: test
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/bash
              lock_passwd: false
          chpasswd:
            expire: false
            list:
              - test:test123
          ssh_pwauth: true
          package_update: false
          packages:
            - curl
            - openssh-server
          runcmd:
            - systemctl enable ssh
            - systemctl start ssh
            - echo "Cloud-init completed" > /tmp/cloud-init-done
          USERDATA

          # Remove leading spaces (heredoc preserves them)
          sed -i 's/^          //' /tmp/cloud-init/user-data

          # Create meta-data
          cat > /tmp/cloud-init/meta-data << 'METADATA'
          instance-id: e2e-debian-arm64
          local-hostname: e2e-debian
          METADATA
          sed -i 's/^          //' /tmp/cloud-init/meta-data

          # Show config for debugging
          echo "=== user-data ==="
          cat /tmp/cloud-init/user-data
          echo "=== meta-data ==="
          cat /tmp/cloud-init/meta-data

          # Create cloud-init ISO
          genisoimage -output /tmp/cloud-init.iso -volid cidata -joliet -rock \
            /tmp/cloud-init/user-data /tmp/cloud-init/meta-data

      - name: Start Debian VM with virt-install
        run: |
          echo "=== Creating Debian VM (ARM64) ==="
          echo "KVM_AVAILABLE: $KVM_AVAILABLE"

          # Create a copy of the base image
          sudo cp /tmp/debian-12-generic-arm64.qcow2 /var/lib/libvirt/images/e2e-debian.qcow2
          sudo qemu-img resize /var/lib/libvirt/images/e2e-debian.qcow2 10G

          # Determine virt-type based on KVM availability
          if [ "$KVM_AVAILABLE" = "true" ]; then
            VIRT_TYPE="kvm"
          else
            VIRT_TYPE="qemu"
          fi
          echo "Using virt-type: $VIRT_TYPE"

          # Find UEFI firmware path
          UEFI_CODE=""
          if [ -f /usr/share/AAVMF/AAVMF_CODE.fd ]; then
            UEFI_CODE="/usr/share/AAVMF/AAVMF_CODE.fd"
          elif [ -f /usr/share/qemu-efi-aarch64/QEMU_EFI.fd ]; then
            UEFI_CODE="/usr/share/qemu-efi-aarch64/QEMU_EFI.fd"
          fi
          echo "UEFI firmware: ${UEFI_CODE:-auto}"

          # Build virt-install command
          VIRT_INSTALL_ARGS=(
            --name e2e-debian
            --memory 2048
            --vcpus 2
            --disk /var/lib/libvirt/images/e2e-debian.qcow2,format=qcow2
            --disk /tmp/cloud-init.iso,device=cdrom
            --os-variant debian12
            --virt-type "$VIRT_TYPE"
            --arch aarch64
            --machine virt
            --network network=default
            --graphics none
            --console pty,target_type=serial
            --noautoconsole
            --import
            --wait 0
          )

          # Add UEFI boot option
          if [ -n "$UEFI_CODE" ]; then
            VIRT_INSTALL_ARGS+=(--boot loader="$UEFI_CODE",loader.readonly=yes,loader.type=pflash)
          else
            VIRT_INSTALL_ARGS+=(--boot uefi)
          fi

          # Create VM with virt-install
          echo "=== Running virt-install ==="
          sudo virt-install "${VIRT_INSTALL_ARGS[@]}"

          # Wait for VM to boot and get IP
          # TCG (no KVM) is much slower, wait longer
          if [ "$KVM_AVAILABLE" = "true" ]; then
            BOOT_WAIT=90
          else
            echo "Note: Using QEMU TCG (software emulation) - boot will be slower"
            BOOT_WAIT=300
          fi
          echo "=== Waiting ${BOOT_WAIT}s for VM to boot ==="
          sleep $BOOT_WAIT

          # Get VM IP (retry a few times)
          for i in {1..10}; do
            VM_IP=$(sudo virsh domifaddr e2e-debian 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)
            if [ -n "$VM_IP" ]; then
              break
            fi
            echo "Waiting for VM IP (attempt $i/10)..."
            sleep 15
          done

          if [ -z "$VM_IP" ]; then
            echo "ERROR: Could not get VM IP address"
            echo "=== VM Status ==="
            sudo virsh list --all
            echo "=== VM Info ==="
            sudo virsh dominfo e2e-debian || true
            echo "=== Network Info ==="
            sudo virsh net-list --all
            sudo virsh net-dhcp-leases default || true
            echo "=== VM Interfaces ==="
            sudo virsh domifaddr e2e-debian --source agent || true
            sudo virsh domifaddr e2e-debian --source arp || true
            sudo virsh domifaddr e2e-debian --source lease || true
            exit 1
          fi

          echo "VM IP: $VM_IP"
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV

      - name: Run VM installation test
        run: |
          echo "=== Running installation tests on ARM64 VM ==="
          echo "VM_IP: $VM_IP"

          # Wait for SSH to be ready (cloud-init may still be running)
          # More retries for TCG mode (slower boot)
          echo "Waiting for SSH to be ready..."
          MAX_ATTEMPTS=60
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
               -o ConnectTimeout=10 test@$VM_IP "echo SSH ready" 2>/dev/null; then
              echo "SSH connection established on attempt $i"
              break
            fi
            echo "SSH not ready yet (attempt $i/$MAX_ATTEMPTS)..."
            sleep 10
          done

          # Verify SSH works
          if ! sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
             test@$VM_IP "uname -a"; then
            echo "ERROR: SSH connection failed after all retries"
            echo "=== Testing network connectivity ==="
            ping -c 3 $VM_IP || echo "Cannot ping VM"
            echo "=== Checking SSH port ==="
            nc -zv $VM_IP 22 2>&1 || echo "SSH port not open"
            exit 1
          fi

          # Create directory structure on VM (mimic Vagrant mounts)
          echo "Creating directory structure on VM..."
          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo mkdir -p /setup /bin-local /vagrant"

          # Copy files to VM using scp (to /tmp first, then move with sudo)
          echo "Copying test files to VM..."
          sshpass -p "test123" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            setup/install.sh setup/uninstall.sh test@$VM_IP:/tmp/
          sshpass -p "test123" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            bin/supervizio test@$VM_IP:/tmp/
          sshpass -p "test123" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            e2e/test-install.sh test@$VM_IP:/tmp/

          # Move files to correct locations (like Vagrant rsync mounts)
          echo "Setting up file structure..."
          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo mv /tmp/install.sh /tmp/uninstall.sh /setup/ && \
                         sudo mv /tmp/supervizio /bin-local/ && \
                         sudo chmod +x /setup/*.sh /bin-local/supervizio"

          # Run test script
          echo "Running test-install.sh..."
          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo chmod +x /tmp/test-install.sh && sudo /tmp/test-install.sh"

          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: always()
        run: |
          sudo virsh destroy e2e-debian 2>/dev/null || true
          sudo virsh undefine e2e-debian --remove-all-storage 2>/dev/null || true

      # =========================================================================
      # Container Test: Debian via Docker
      # =========================================================================
      - name: Build Debian container (arm64)
        run: |
          docker build \
            -f e2e/Dockerfile.debian \
            -t supervizio-debian:arm64 .
          echo "=== Image info ==="
          docker images supervizio-debian:arm64

      - name: Test Debian container (arm64)
        run: |
          echo "=== Testing supervizio in Debian container (arm64) ==="
          docker run --rm supervizio-debian:arm64
          echo "=== Container test passed ==="

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== KVM Status ==="
          echo "KVM_AVAILABLE: $KVM_AVAILABLE"
          ls -la /dev/kvm 2>/dev/null || echo "/dev/kvm not found"

          echo "=== libvirt Status ==="
          systemctl status libvirtd --no-pager || true

          echo "=== libvirt VMs ==="
          sudo virsh list --all || true

          echo "=== VM Info ==="
          sudo virsh dominfo e2e-debian 2>/dev/null || echo "VM not found"

          echo "=== Network Info ==="
          sudo virsh net-list --all || true
          sudo virsh net-dhcp-leases default 2>/dev/null || true

          echo "=== VM IP Attempts ==="
          sudo virsh domifaddr e2e-debian 2>/dev/null || true

          echo "=== QEMU Processes ==="
          ps aux | grep -i qemu || true

          echo "=== Docker Images ==="
          docker images || true
