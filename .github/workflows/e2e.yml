# =============================================================================
# E2E Tests - Full Platform Matrix
# =============================================================================
# Tests supervizio across all supported platforms and init systems:
#
# Linux (AMD64 + ARM64):
#   - Debian 13 (systemd)
#   - Ubuntu 24.04 (systemd)
#   - Alpine 3.20 (OpenRC)
#   - Devuan 5 (SysVinit)
#   - Void Linux (runit)
#
# BSD (AMD64 only):
#   - FreeBSD 14
#   - OpenBSD 7.5
#   - NetBSD 10
#   - DragonFlyBSD 6.4
#
# Total: 15 jobs (5 Linux AMD64 + 5 Linux ARM64 + 4 BSD AMD64 + 1 PID1)
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # Linux AMD64 E2E Tests (Vagrant + Docker)
  # ===========================================================================
  e2e-linux-amd64:
    name: E2E AMD64 ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          # systemd distributions
          - name: Debian
            vm: debian13
            dockerfile: Dockerfile.debian
            init: systemd
          - name: Ubuntu
            vm: ubuntu
            dockerfile: Dockerfile.ubuntu
            init: systemd
          # OpenRC distribution
          - name: Alpine
            vm: alpine
            dockerfile: Dockerfile.alpine
            init: openrc
          # SysVinit distribution
          - name: Devuan
            vm: devuan
            dockerfile: Dockerfile.devuan
            init: sysvinit
          # runit distribution (container only - no libvirt Vagrant box available)
          - name: Void
            vm: void
            dockerfile: Dockerfile.void
            init: runit
            skip_vm: true
            reason_vm: "no Vagrant box available"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/amd64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test via Vagrant + libvirt/KVM (skip if no box available)
      # =========================================================================
      - name: Setup KVM
        if: ${{ matrix.skip_vm != true }}
        run: |
          echo "=== Checking KVM availability ==="
          if [ -e /dev/kvm ]; then
            echo "KVM device found, configuring permissions..."
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            ls -la /dev/kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "WARNING: /dev/kvm not found"
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Install libvirt and dependencies
        if: ${{ matrix.skip_vm != true }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            ebtables \
            ruby-dev \
            ruby-libvirt \
            build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        if: ${{ matrix.skip_vm != true }}
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        if: ${{ matrix.skip_vm != true }}
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-libvirt-amd64-v1

      - name: Start ${{ matrix.name }} VM
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: |
          echo "=== Starting ${{ matrix.name }} VM (AMD64, ${{ matrix.init }}) ==="
          sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt
          echo "=== VM started ==="

      - name: Run VM installation test
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: |
          echo "=== Running installation tests on ${{ matrix.name }} (${{ matrix.init }}) ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"
          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: ${{ always() && matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

      - name: Skip VM test notice
        if: ${{ matrix.skip_vm == true }}
        run: echo "Skipping VM test for ${{ matrix.name }} AMD64 (${{ matrix.reason_vm }})"

      # =========================================================================
      # Container Test via Docker
      # =========================================================================
      - name: Build ${{ matrix.name }} container (amd64)
        run: |
          docker build \
            -f e2e/${{ matrix.dockerfile }} \
            -t supervizio-${{ matrix.vm }}:amd64 .
          echo "=== Image info ==="
          docker images supervizio-${{ matrix.vm }}:amd64

      - name: Test ${{ matrix.name }} container (amd64)
        run: |
          echo "=== Testing supervizio in ${{ matrix.name }} container (amd64) ==="
          docker run --rm supervizio-${{ matrix.vm }}:amd64
          echo "=== Container test passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Docker Images ==="
          docker images || true

  # ===========================================================================
  # Linux ARM64 E2E Tests (virt-install + Docker)
  # Note: Vagrant not available for ARM64 Linux
  # ===========================================================================
  e2e-linux-arm64:
    name: E2E ARM64 ${{ matrix.name }}
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        include:
          # systemd distributions (VM via virt-install + cloud-init)
          - name: Debian
            vm: debian
            dockerfile: Dockerfile.debian
            init: systemd
            os_variant: debian12
            cloud_image_url: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-arm64.qcow2"
            cloud_image_file: "debian-12-genericcloud-arm64.qcow2"
          - name: Ubuntu
            vm: ubuntu
            dockerfile: Dockerfile.ubuntu
            init: systemd
            os_variant: ubuntu22.04
            cloud_image_url: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-arm64.img"
            cloud_image_file: "jammy-server-cloudimg-arm64.img"
          # OpenRC distribution (VM via virt-install + cloud-init)
          - name: Alpine
            vm: alpine
            dockerfile: Dockerfile.alpine
            init: openrc
            os_variant: alpinelinux3.19
            cloud_image_url: "https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/cloud/generic_alpine-3.20.0-aarch64-uefi-cloudinit-r0.qcow2"
            cloud_image_file: "alpine-3.20-arm64.qcow2"
          # SysVinit - Devuan has no ARM64 images (VM or container)
          - name: Devuan
            vm: devuan
            init: sysvinit
            skip_vm: true
            reason_vm: "no ARM64 cloud image available"
            skip_container: true
            reason_container: "no ARM64 Docker image available"
          # runit distribution (container only - Void has no cloud-init images)
          - name: Void
            vm: void
            dockerfile: Dockerfile.void
            init: runit
            skip_vm: true
            reason_vm: "no cloud-init compatible image"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/arm64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test via virt-install + cloud-init (skip if no ARM64 image)
      # =========================================================================
      - name: Setup KVM
        if: ${{ matrix.skip_vm != true }}
        run: |
          echo "=== Checking KVM availability ==="
          if [ -e /dev/kvm ]; then
            echo "KVM device found, configuring permissions..."
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            ls -la /dev/kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "WARNING: /dev/kvm not found - VM tests will use QEMU TCG"
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Install libvirt and virt-install
        if: ${{ matrix.skip_vm != true }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-clients \
            virtinst \
            qemu-kvm \
            qemu-system-arm \
            qemu-efi-aarch64 \
            cloud-image-utils \
            genisoimage \
            sshpass
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER
          sudo virsh net-start default 2>/dev/null || true
          sudo virsh net-autostart default 2>/dev/null || true

      - name: Cache cloud image
        if: ${{ matrix.skip_vm != true }}
        uses: actions/cache@v4
        with:
          path: /tmp/${{ matrix.cloud_image_file }}
          key: ${{ matrix.vm }}-cloud-arm64-v1

      - name: Download ${{ matrix.name }} ARM64 cloud image
        if: ${{ matrix.skip_vm != true }}
        run: |
          if [ ! -f /tmp/${{ matrix.cloud_image_file }} ]; then
            echo "=== Downloading ${{ matrix.name }} ARM64 cloud image ==="
            wget -q -O /tmp/${{ matrix.cloud_image_file }} \
              "${{ matrix.cloud_image_url }}"
          fi
          ls -lh /tmp/${{ matrix.cloud_image_file }}

      - name: Create cloud-init configuration
        if: ${{ matrix.skip_vm != true }}
        run: |
          mkdir -p /tmp/cloud-init

          # Determine shell based on init system (Alpine uses ash)
          if [ "${{ matrix.init }}" = "openrc" ]; then
            USER_SHELL="/bin/ash"
            PACKAGES="curl openssh"
          else
            USER_SHELL="/bin/bash"
            PACKAGES="curl openssh-server"
          fi

          cat > /tmp/cloud-init/user-data << USERDATA
          #cloud-config
          users:
            - name: test
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: ${USER_SHELL}
              lock_passwd: false
          chpasswd:
            expire: false
            list:
              - test:test123
          ssh_pwauth: true
          package_update: false
          packages:
            - curl
          runcmd:
            - systemctl enable ssh || rc-update add sshd default || true
            - systemctl start ssh || rc-service sshd start || true
            - echo "Cloud-init completed" > /tmp/cloud-init-done
          USERDATA
          sed -i 's/^          //' /tmp/cloud-init/user-data

          cat > /tmp/cloud-init/meta-data << METADATA
          instance-id: e2e-${{ matrix.vm }}-arm64
          local-hostname: e2e-${{ matrix.vm }}
          METADATA
          sed -i 's/^          //' /tmp/cloud-init/meta-data

          genisoimage -output /tmp/cloud-init.iso -volid cidata -joliet -rock \
            /tmp/cloud-init/user-data /tmp/cloud-init/meta-data

      - name: Start ${{ matrix.name }} VM with virt-install
        if: ${{ matrix.skip_vm != true }}
        run: |
          echo "=== Creating ${{ matrix.name }} VM (ARM64, ${{ matrix.init }}) ==="

          sudo cp /tmp/${{ matrix.cloud_image_file }} /var/lib/libvirt/images/e2e-${{ matrix.vm }}.qcow2
          sudo qemu-img resize /var/lib/libvirt/images/e2e-${{ matrix.vm }}.qcow2 10G 2>/dev/null || true

          VIRT_TYPE="qemu"
          [ "$KVM_AVAILABLE" = "true" ] && VIRT_TYPE="kvm"

          UEFI_CODE=""
          [ -f /usr/share/AAVMF/AAVMF_CODE.fd ] && UEFI_CODE="/usr/share/AAVMF/AAVMF_CODE.fd"
          [ -f /usr/share/qemu-efi-aarch64/QEMU_EFI.fd ] && UEFI_CODE="/usr/share/qemu-efi-aarch64/QEMU_EFI.fd"

          BOOT_OPT="--boot uefi"
          [ -n "$UEFI_CODE" ] && BOOT_OPT="--boot loader=$UEFI_CODE,loader.readonly=yes,loader.type=pflash"

          sudo virt-install \
            --name e2e-${{ matrix.vm }} \
            --memory 2048 \
            --vcpus 2 \
            --disk /var/lib/libvirt/images/e2e-${{ matrix.vm }}.qcow2,format=qcow2 \
            --disk /tmp/cloud-init.iso,device=cdrom \
            --os-variant ${{ matrix.os_variant }} \
            --virt-type "$VIRT_TYPE" \
            --arch aarch64 \
            --machine virt \
            --network network=default \
            --graphics none \
            --console pty,target_type=serial \
            --noautoconsole \
            --import \
            --wait 0 \
            $BOOT_OPT

          BOOT_WAIT=90
          [ "$KVM_AVAILABLE" != "true" ] && BOOT_WAIT=300
          echo "=== Waiting ${BOOT_WAIT}s for VM to boot ==="
          sleep $BOOT_WAIT

          for i in {1..10}; do
            VM_IP=$(sudo virsh domifaddr e2e-${{ matrix.vm }} 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)
            [ -n "$VM_IP" ] && break
            echo "Waiting for VM IP (attempt $i/10)..."
            sleep 15
          done

          if [ -z "$VM_IP" ]; then
            echo "ERROR: Could not get VM IP address"
            sudo virsh list --all
            exit 1
          fi

          echo "VM IP: $VM_IP"
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV

      - name: Run VM installation test
        if: ${{ matrix.skip_vm != true }}
        run: |
          echo "=== Running installation tests on ${{ matrix.name }} ARM64 VM ==="

          MAX_ATTEMPTS=60
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
               -o ConnectTimeout=10 test@$VM_IP "echo SSH ready" 2>/dev/null; then
              echo "SSH connection established on attempt $i"
              break
            fi
            echo "SSH not ready yet (attempt $i/$MAX_ATTEMPTS)..."
            sleep 10
          done

          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo mkdir -p /setup /bin-local /vagrant && mkdir -p /tmp/setup-files"

          sshpass -p "test123" scp -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            setup/* test@$VM_IP:/tmp/setup-files/
          sshpass -p "test123" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            bin/supervizio test@$VM_IP:/tmp/
          sshpass -p "test123" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            e2e/test-install.sh test@$VM_IP:/tmp/

          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo cp -r /tmp/setup-files/* /setup/ && \
                         sudo mv /tmp/supervizio /bin-local/ && \
                         sudo chmod +x /setup/*.sh /bin-local/supervizio"

          sshpass -p "test123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            test@$VM_IP "sudo chmod +x /tmp/test-install.sh && sudo /tmp/test-install.sh"

          echo "=== VM tests passed ==="

      - name: Skip VM test notice
        if: ${{ matrix.skip_vm == true }}
        run: echo "Skipping VM test for ${{ matrix.name }} ARM64 (${{ matrix.reason_vm }})"

      - name: Cleanup VM
        if: ${{ always() && matrix.skip_vm != true }}
        run: |
          sudo virsh destroy e2e-${{ matrix.vm }} 2>/dev/null || true
          sudo virsh undefine e2e-${{ matrix.vm }} --remove-all-storage 2>/dev/null || true

      # =========================================================================
      # Container Test via Docker
      # =========================================================================
      - name: Build ${{ matrix.name }} container (arm64)
        if: ${{ matrix.skip_container != true }}
        run: |
          docker build \
            -f e2e/${{ matrix.dockerfile }} \
            -t supervizio-${{ matrix.vm }}:arm64 .
          echo "=== Image info ==="
          docker images supervizio-${{ matrix.vm }}:arm64

      - name: Test ${{ matrix.name }} container (arm64)
        if: ${{ matrix.skip_container != true }}
        run: |
          echo "=== Testing supervizio in ${{ matrix.name }} container (arm64) ==="
          docker run --rm supervizio-${{ matrix.vm }}:arm64
          echo "=== Container test passed ==="

      - name: Skip container test notice
        if: ${{ matrix.skip_container == true }}
        run: echo "Skipping container test for ${{ matrix.name }} ARM64 (${{ matrix.reason_container }})"

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== KVM Status ==="
          ls -la /dev/kvm 2>/dev/null || echo "/dev/kvm not found"
          echo "=== libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Docker Images ==="
          docker images || true

  # ===========================================================================
  # BSD AMD64 E2E Tests (Vagrant only - no Docker on BSD)
  # ===========================================================================
  e2e-bsd-amd64:
    name: E2E AMD64 ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: FreeBSD
            vm: freebsd
            goos: freebsd
          - name: OpenBSD
            vm: openbsd
            goos: openbsd
          - name: NetBSD
            vm: netbsd
            goos: netbsd
            skip_vm: true
            reason_vm: "Vagrant box is flaky"
          - name: DragonFlyBSD
            vm: dragonfly
            goos: dragonfly
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (${{ matrix.goos }}/amd64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test via Vagrant + libvirt/KVM (skip if box is flaky)
      # =========================================================================
      - name: Setup KVM
        if: ${{ matrix.skip_vm != true }}
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Install libvirt and dependencies
        if: ${{ matrix.skip_vm != true }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            ebtables \
            ruby-dev \
            ruby-libvirt \
            build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        if: ${{ matrix.skip_vm != true }}
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        if: ${{ matrix.skip_vm != true }}
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-libvirt-amd64-v1

      - name: Start ${{ matrix.name }} VM
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: |
          echo "=== Starting ${{ matrix.name }} VM (AMD64, rc.d) ==="
          sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt
          echo "=== VM started ==="

      - name: Run VM installation test
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: |
          echo "=== Running installation tests on ${{ matrix.name }} (rc.d) ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"
          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: ${{ always() && matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

      - name: Skip VM test notice
        if: ${{ matrix.skip_vm == true }}
        run: echo "Skipping VM test for ${{ matrix.name }} AMD64 (${{ matrix.reason_vm }})"

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== libvirt VMs ==="
          sudo virsh list --all || true

  # ===========================================================================
  # PID1 Container Tests (supervizio as container init)
  # ===========================================================================
  e2e-pid1:
    name: E2E PID1 Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/amd64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      - name: Build PID1 test container
        run: |
          docker build -f e2e/Dockerfile.pid1 -t supervizio-pid1:test .

      - name: Start PID1 container
        run: |
          docker run -d --name supervizio-pid1 \
            -p 8080:80 -p 6379:6379 \
            supervizio-pid1:test --config /etc/supervizio/config.yaml
          sleep 15

      - name: Run PID1 tests
        run: |
          chmod +x e2e/test-container.sh
          CONTAINER_NAME=supervizio-pid1 ./e2e/test-container.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          docker logs supervizio-pid1 2>&1 || true
          docker exec supervizio-pid1 ps aux 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: |
          docker stop supervizio-pid1 2>/dev/null || true
          docker rm supervizio-pid1 2>/dev/null || true
