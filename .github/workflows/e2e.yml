# =============================================================================
# E2E Tests - VM and Container Testing
# =============================================================================
# Tests supervizio in multiple environments:
# - Linux VMs via Vagrant + libvirt/KVM (systemd, OpenRC)
# - BSD VMs via Vagrant + libvirt/KVM (rc.d)
# - Containers via Docker + QEMU binfmt (PID1 mode, scratch image)
#
# Architecture:
# - AMD64: KVM native (reliable)
# - ARM64: QEMU emulation (experimental, soft-fail)
#
# Matrix: 7 required + 9 experimental jobs
# - vm-linux: 3 AMD64 (debian, ubuntu, alpine) + 4 ARM64 experimental
# - vm-bsd: 1 AMD64 (freebsd) + 5 experimental (openbsd, netbsd, ARM64)
# - container: 2 jobs (amd64 required, arm64 experimental)
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # Linux VM Tests (Vagrant + libvirt/KVM)
  # ===========================================================================
  # 4 distros × 2 architectures = 8 jobs
  # ===========================================================================
  vm-linux:
    name: Linux ${{ matrix.distro }} (${{ matrix.arch }})${{ matrix.experimental && ' [exp]' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ matrix.timeout }}
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ─── DEBIAN (systemd) ─────────────────────────────────────────────
          - distro: debian
            vm: debian
            arch: amd64
            goarch: amd64
            timeout: 15
            use_kvm: true
            experimental: false
          - distro: debian
            vm: debian-arm64
            arch: arm64
            goarch: arm64
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

          # ─── UBUNTU (systemd) ─────────────────────────────────────────────
          - distro: ubuntu
            vm: ubuntu
            arch: amd64
            goarch: amd64
            timeout: 15
            use_kvm: true
            experimental: false
          - distro: ubuntu
            vm: ubuntu-arm64
            arch: arm64
            goarch: arm64
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

          # ─── ALPINE (OpenRC) ──────────────────────────────────────────────
          - distro: alpine
            vm: alpine
            arch: amd64
            goarch: amd64
            timeout: 15
            use_kvm: true
            experimental: false
          - distro: alpine
            vm: alpine-arm64
            arch: arm64
            goarch: arm64
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

          # ─── ROCKY (systemd, RHEL-compatible) ─────────────────────────────
          - distro: rocky
            vm: rocky
            arch: amd64
            goarch: amd64
            timeout: 20
            use_kvm: true
            experimental: true  # Box has known issues
          - distro: rocky
            vm: rocky-arm64
            arch: arm64
            goarch: arm64
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/${{ matrix.arch }})
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      - name: Enable KVM
        if: matrix.use_kvm
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Install libvirt and dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            qemu-system-arm \
            qemu-efi-aarch64 \
            ebtables \
            libguestfs-tools \
            ruby-dev \
            ruby-libvirt \
            build-essential

          sudo systemctl start libvirtd
          sudo systemctl enable libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant

      - name: Install vagrant-libvirt plugin
        run: |
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-libvirt-${{ matrix.arch }}-v4

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Cleanup on exit
          trap 'sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true' EXIT

          if [ "${{ matrix.use_kvm }}" = "true" ]; then
            echo "=== Verifying KVM ==="
            kvm-ok || true
            ls -la /dev/kvm
          else
            echo "=== QEMU emulation mode (no KVM) ==="
          fi

          echo "=== Starting ${{ matrix.vm }} VM (${{ matrix.arch }}) ==="
          sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt --no-parallel

          echo "=== Running installation tests ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"

          echo "=== E2E tests passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== Vagrant Debug ==="
          sudo vagrant up ${{ matrix.vm }} --provider=libvirt --debug 2>&1 | tail -100 || true
          echo "=== Libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Libvirt Networks ==="
          sudo virsh net-list --all || true

  # ===========================================================================
  # BSD VM Tests (Vagrant + libvirt/KVM)
  # ===========================================================================
  # 3 distros × 2 architectures = 6 jobs
  # ===========================================================================
  vm-bsd:
    name: BSD ${{ matrix.distro }} (${{ matrix.arch }})${{ matrix.experimental && ' [exp]' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ matrix.timeout }}
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ─── FREEBSD (rc.d) ───────────────────────────────────────────────
          - distro: freebsd
            vm: freebsd
            arch: amd64
            goarch: amd64
            goos: freebsd
            timeout: 20
            use_kvm: true
            experimental: false
          - distro: freebsd
            vm: freebsd-arm64
            arch: arm64
            goarch: arm64
            goos: freebsd
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

          # ─── OPENBSD (rc.d) ───────────────────────────────────────────────
          - distro: openbsd
            vm: openbsd
            arch: amd64
            goarch: amd64
            goos: openbsd
            timeout: 25
            use_kvm: true
            experimental: true  # Box has compatibility issues
          - distro: openbsd
            vm: openbsd-arm64
            arch: arm64
            goarch: arm64
            goos: openbsd
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

          # ─── NETBSD (rc.d) ────────────────────────────────────────────────
          - distro: netbsd
            vm: netbsd
            arch: amd64
            goarch: amd64
            goos: netbsd
            timeout: 25
            use_kvm: true
            experimental: true  # Box has compatibility issues
          - distro: netbsd
            vm: netbsd-arm64
            arch: arm64
            goarch: arm64
            goos: netbsd
            timeout: 45
            use_kvm: false
            experimental: true  # ARM64 QEMU emulation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (${{ matrix.goos }}/${{ matrix.arch }})
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      - name: Enable KVM
        if: matrix.use_kvm
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Install libvirt and dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            qemu-system-arm \
            qemu-efi-aarch64 \
            qemu-efi-arm \
            ebtables \
            libguestfs-tools \
            ruby-dev \
            ruby-libvirt \
            build-essential

          sudo systemctl start libvirtd
          sudo systemctl enable libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant

      - name: Install vagrant-libvirt plugin
        run: |
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-libvirt-${{ matrix.arch }}-v4

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Cleanup on exit
          trap 'sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true' EXIT

          if [ "${{ matrix.use_kvm }}" = "true" ]; then
            echo "=== Verifying KVM ==="
            kvm-ok || true
            ls -la /dev/kvm
          else
            echo "=== QEMU emulation mode (no KVM) ==="
          fi

          echo "=== Starting ${{ matrix.vm }} VM (${{ matrix.arch }}) ==="
          sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt --no-parallel

          echo "=== Running installation tests ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"

          echo "=== E2E tests passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== Vagrant Debug ==="
          sudo vagrant up ${{ matrix.vm }} --provider=libvirt --debug 2>&1 | tail -100 || true
          echo "=== Libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Libvirt Networks ==="
          sudo virsh net-list --all || true

  # ===========================================================================
  # Container Tests (Docker + QEMU binfmt for multi-arch)
  # ===========================================================================
  # 1 test type × 2 architectures = 2 jobs
  # ===========================================================================
  container:
    name: Container (${{ matrix.arch }})${{ matrix.experimental && ' [exp]' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ matrix.timeout }}
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ─── AMD64 (native) ──────────────────────────────────────────────────
          - arch: amd64
            goarch: amd64
            platform: linux/amd64
            timeout: 15
            experimental: false
          # ─── ARM64 (QEMU emulation) ──────────────────────────────────────────
          - arch: arm64
            goarch: arm64
            platform: linux/arm64
            timeout: 30
            experimental: true  # QEMU emulation may have timing issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build static binary (linux/${{ matrix.arch }})
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # ─────────────────────────────────────────────────────────────────────────
      # Scratch Test - Validates static binary works in minimal container
      # ─────────────────────────────────────────────────────────────────────────
      - name: Verify static binary
        run: |
          if file bin/supervizio | grep -q "dynamically linked"; then
            echo "ERROR: Binary is dynamically linked!"
            exit 1
          fi
          echo "✓ Binary is statically linked for ${{ matrix.arch }}"

      - name: Build scratch image (${{ matrix.arch }})
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -f e2e/Dockerfile.scratch \
            -t supervizio-scratch:${{ matrix.arch }} .
          echo "=== Image info ==="
          docker images supervizio-scratch:${{ matrix.arch }}

      - name: Test scratch container (${{ matrix.arch }})
        run: |
          echo "=== Testing static binary in scratch container (${{ matrix.arch }}) ==="
          # Test 1: Binary executes in scratch (no libc required)
          docker run --rm --platform ${{ matrix.platform }} \
            --entrypoint /supervizio supervizio-scratch:${{ matrix.arch }} --version
          echo "✓ Binary executes in scratch container (${{ matrix.arch }})"

          # Test 2: Binary can read config file
          docker run --rm --platform ${{ matrix.platform }} \
            --entrypoint /supervizio supervizio-scratch:${{ matrix.arch }} --help 2>&1 | head -5
          echo "✓ Binary runs without dependencies (${{ matrix.arch }})"

      # ─────────────────────────────────────────────────────────────────────────
      # PID1 Test - Validates supervizio as container init managing services
      # ─────────────────────────────────────────────────────────────────────────
      - name: Build PID1 test image (${{ matrix.arch }})
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -f e2e/Dockerfile.pid1 \
            -t supervizio-pid1:${{ matrix.arch }} .
          echo "=== Image info ==="
          docker images supervizio-pid1:${{ matrix.arch }}

      - name: Start PID1 container (${{ matrix.arch }})
        run: |
          docker run -d \
            --platform ${{ matrix.platform }} \
            --name supervizio-pid1-${{ matrix.arch }} \
            supervizio-pid1:${{ matrix.arch }}
          echo "Waiting for services to start..."
          sleep 15
          docker ps --filter name=supervizio-pid1-${{ matrix.arch }} --format "table {{.Names}}\t{{.Status}}"

      - name: Run PID1 container tests (${{ matrix.arch }})
        run: |
          chmod +x e2e/test-container.sh
          CONTAINER_NAME=supervizio-pid1-${{ matrix.arch }} ./e2e/test-container.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Container status ==="
          docker ps -a || true
          echo "=== Container logs ==="
          docker logs supervizio-pid1-${{ matrix.arch }} 2>&1 || true
          echo "=== Container processes ==="
          docker exec supervizio-pid1-${{ matrix.arch }} ps aux 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          docker stop supervizio-pid1-${{ matrix.arch }} 2>/dev/null || true
          docker rm -f supervizio-pid1-${{ matrix.arch }} 2>/dev/null || true
          docker rmi -f supervizio-scratch:${{ matrix.arch }} 2>/dev/null || true
          docker rmi -f supervizio-pid1:${{ matrix.arch }} 2>/dev/null || true
