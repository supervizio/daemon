name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # =============================================================================
  # E2E Tests on Debian (ARM64 + AMD64)
  # Uses macOS runners with QEMU for native-speed virtualization
  # =============================================================================
  e2e-debian:
    name: E2E Debian (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: arm64
            qemu_system: qemu-system-aarch64
          - runner: macos-15-intel
            arch: amd64
            qemu_system: qemu-system-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      - name: Install Vagrant
        run: brew install --cask vagrant

      - name: Install QEMU
        run: brew install qemu

      - name: Install vagrant-qemu plugin
        run: vagrant plugin install vagrant-qemu

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-debian12-${{ matrix.arch }}-v5

      - name: Run E2E tests
        working-directory: e2e
        env:
          # Explicitly set CI flag for Vagrantfile to detect
          CI: "true"
          VAGRANT_DISABLE_HVF: "true"
        run: |
          # Ensure VM cleanup on exit (success or failure)
          trap 'echo "=== Cleaning up ==="; vagrant destroy debian -f' EXIT

          echo "=== Starting Debian VM (${{ matrix.arch }}) ==="
          echo "CI=$CI VAGRANT_DISABLE_HVF=$VAGRANT_DISABLE_HVF"
          vagrant up debian --provider=qemu

          echo "=== Running installation tests ==="
          vagrant ssh debian -c "sudo /vagrant/test-install.sh"

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          vagrant status || true
          echo "=== QEMU Processes ==="
          pgrep -la qemu || true
