# =============================================================================
# E2E Tests - Platform Matrix
# =============================================================================
# Tests supervizio across all supported platforms and init systems.
# AMD64 only (setup scripts are architecture-agnostic).
#
# Linux (5 jobs) - e2e-linux:
#   - Debian 12 (systemd) - Vagrant + Docker
#   - Rocky 9 (systemd) - Vagrant + Docker
#   - Alpine 3.19 (OpenRC) - Vagrant + Docker
#   - Devuan 4 (SysVinit) - Vagrant + Docker
#   - Alpine 3.20 (runit) - Vagrant + Docker
#
# BSD (4 jobs) - e2e-bsd:
#   - FreeBSD 14 (rc.d) - Vagrant
#   - OpenBSD 7 (rc.d) - Vagrant
#   - NetBSD 9 (rc.d) - Vagrant
#   - DragonFlyBSD 6 (rc.d) - Vagrant
#
# Total: 9 jobs (2 workflow jobs)
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # Linux E2E Tests (Vagrant + Docker)
  # ===========================================================================
  e2e-linux:
    name: E2E ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian
            vm: debian13
            dockerfile: Dockerfile.debian
            init: systemd
          - name: Rocky
            vm: rocky
            dockerfile: Dockerfile.rocky
            init: systemd
          - name: Alpine
            vm: alpine
            dockerfile: Dockerfile.alpine
            init: openrc
          - name: Devuan
            vm: devuan
            dockerfile: Dockerfile.devuan
            init: sysvinit
          - name: Alpine-runit
            vm: alpine-runit
            dockerfile: Dockerfile.alpine-runit
            init: runit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      # =========================================================================
      # VM Test via Vagrant + libvirt/KVM
      # =========================================================================
      - name: Setup KVM
        if: ${{ matrix.skip_vm != true }}
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        if: ${{ matrix.skip_vm != true }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libvirt-daemon-system libvirt-dev libvirt-clients qemu-kvm ruby-dev ruby-libvirt build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Install Vagrant from HashiCorp
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq && sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        if: ${{ matrix.skip_vm != true }}
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-v1

      - name: Start VM
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt

      - name: Sync folders
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: |
          # Wait for VM to be fully ready (some VMs need time after provisioning)
          # Rocky Linux 9 in particular needs extra time after dnf operations
          echo "=== Waiting for VM to be SSH-ready ==="
          for i in $(seq 1 24); do
            if sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'VM ready'" 2>/dev/null; then
              echo "=== VM is SSH-accessible after $((i * 5)) seconds ==="
              break
            fi
            if [ "$i" = "24" ]; then
              echo "ERROR: VM not SSH-accessible after 120 seconds"
              echo "=== VM status ==="
              sudo -E vagrant status ${{ matrix.vm }} || true
              echo "=== Attempting to get VM IP ==="
              sudo -E vagrant ssh-config ${{ matrix.vm }} 2>&1 || true
              echo "=== Checking libvirt domain ==="
              sudo virsh list --all || true
              sudo virsh domifaddr e2e_${{ matrix.vm }} 2>/dev/null || true
              exit 1
            fi
            echo "Waiting for VM... (attempt $i/24)"
            sleep 5
          done

          # Try vagrant rsync first (works for most VMs with rsync pre-installed)
          echo "=== Attempting vagrant rsync ==="
          if sudo -E vagrant rsync ${{ matrix.vm }} 2>&1; then
            echo "=== Rsync succeeded ==="
          else
            echo "=== Rsync failed (exit code: $?), using tar-over-ssh fallback ==="

            # Verify SSH connectivity (should work since we checked above)
            echo "=== Verifying SSH connectivity ==="
            sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'SSH works'; uname -a; which tar" || {
              echo "ERROR: SSH connectivity failed"
              exit 1
            }

            # Create directories on guest
            echo "=== Creating directories ==="
            sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo mkdir -p /setup /bin-local /vagrant && sudo chmod 777 /setup /bin-local /vagrant && ls -la /setup /bin-local /vagrant"

            # Copy files using tar piped through vagrant ssh (same approach as BSD)
            echo "=== Copying setup folder ==="
            tar -cv -C .. setup | sudo -E vagrant ssh ${{ matrix.vm }} -c "cd / && sudo tar -xv" || {
              echo "ERROR: Failed to copy setup folder"
              exit 1
            }

            echo "=== Copying bin folder ==="
            tar -cv -C .. bin | sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo tar -xv -C /bin-local --strip-components=1" || {
              echo "ERROR: Failed to copy bin folder"
              exit 1
            }

            echo "=== Copying vagrant folder ==="
            tar -cv . | sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo tar -xv -C /vagrant" || {
              echo "ERROR: Failed to copy vagrant folder"
              exit 1
            }

            # Fix permissions
            sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo chown -R root:root /setup /bin-local"
          fi

          # Verify files exist
          echo "=== Verifying synced files ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /setup /bin-local /vagrant" || {
            echo "ERROR: Sync verification failed"
            exit 1
          }

      - name: Run VM tests
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"

      - name: Cleanup VM
        if: ${{ always() && matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

      - name: Skip VM notice
        if: ${{ matrix.skip_vm == true }}
        run: echo "Skipping VM test for ${{ matrix.name }} (no Vagrant box)"

      # =========================================================================
      # Container Test via Docker
      # =========================================================================
      - name: Build container
        run: docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-${{ matrix.vm }}:test .

      - name: Test container
        run: docker run --rm supervizio-${{ matrix.vm }}:test

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          sudo vagrant status || true
          sudo virsh list --all || true

  # ===========================================================================
  # BSD E2E Tests (Vagrant + libvirt/KVM)
  # ===========================================================================
  e2e-bsd:
    name: E2E ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: FreeBSD
            vm: freebsd
            goos: freebsd
          - name: OpenBSD
            vm: openbsd
            goos: openbsd
          - name: NetBSD
            vm: netbsd
            goos: netbsd
          - name: DragonFlyBSD
            vm: dragonfly
            goos: dragonfly
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      - name: Setup KVM
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libvirt-daemon-system libvirt-dev libvirt-clients qemu-kvm ruby-dev ruby-libvirt build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Install Vagrant from HashiCorp
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq && sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-v1

      - name: Start VM
        working-directory: e2e
        run: sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt

      - name: Sync folders
        working-directory: e2e
        run: |
          # Wait for VM to be fully ready (BSD VMs may need extra time)
          echo "=== Waiting for VM to be SSH-ready ==="
          for i in $(seq 1 24); do
            if sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'VM ready'" 2>/dev/null; then
              echo "=== VM is SSH-accessible after $((i * 5)) seconds ==="
              break
            fi
            if [ "$i" = "24" ]; then
              echo "ERROR: VM not SSH-accessible after 120 seconds"
              echo "=== VM status ==="
              sudo -E vagrant status ${{ matrix.vm }} || true
              echo "=== Attempting to get VM IP ==="
              sudo -E vagrant ssh-config ${{ matrix.vm }} 2>&1 || true
              echo "=== Checking libvirt domain ==="
              sudo virsh list --all || true
              sudo virsh domifaddr e2e_${{ matrix.vm }} 2>/dev/null || true
              exit 1
            fi
            echo "Waiting for VM... (attempt $i/24)"
            sleep 5
          done

          # Try vagrant rsync first (works for most VMs with rsync pre-installed)
          echo "=== Attempting vagrant rsync ==="
          if sudo -E vagrant rsync ${{ matrix.vm }} 2>&1; then
            echo "=== Rsync succeeded ==="
          else
            echo "=== Rsync failed (exit code: $?), using tar-over-ssh fallback ==="

            # Verify SSH connectivity (should work since we checked above)
            echo "=== Verifying SSH connectivity ==="
            sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'SSH works'; uname -a; which tar" || {
              echo "ERROR: SSH connectivity failed"
              exit 1
            }

            # Create directories on guest
            echo "=== Creating directories ==="
            sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo mkdir -p /setup /bin-local /vagrant && sudo chmod 777 /setup /bin-local /vagrant && ls -la /setup /bin-local /vagrant"

            # Copy files using tar piped through vagrant ssh
            echo "=== Copying setup folder ==="
            tar -cv -C .. setup | sudo -E vagrant ssh ${{ matrix.vm }} -c "cd / && sudo tar -xv" || {
              echo "ERROR: Failed to copy setup folder"
              exit 1
            }

            echo "=== Copying bin folder ==="
            tar -cv -C .. bin | sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo tar -xv -C /bin-local --strip-components=1" || {
              echo "ERROR: Failed to copy bin folder"
              exit 1
            }

            echo "=== Copying vagrant folder ==="
            tar -cv . | sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo tar -xv -C /vagrant" || {
              echo "ERROR: Failed to copy vagrant folder"
              exit 1
            }

            # Fix permissions
            sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo chown -R root:root /setup /bin-local"
          fi

          # Verify files exist
          echo "=== Verifying synced files ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /setup /bin-local /vagrant" || {
            echo "ERROR: Sync verification failed"
            exit 1
          }

      - name: Run VM tests
        working-directory: e2e
        run: |
          # Files synced via vagrant rsync or tar-over-ssh fallback
          echo "=== Step 1: Verify synced folders exist ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /bin-local/ /setup/ /vagrant/" || {
            echo "ERROR: Synced folders not found"
            exit 1
          }

          echo "=== Step 2: Check binary format ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "file /bin-local/supervizio || true; ls -la /bin-local/supervizio"

          echo "=== Step 3: Copy binary to /usr/local/bin ==="
          # Create /usr/local/bin if it doesn't exist (NetBSD uses /usr/pkg/bin by default)
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo mkdir -p /usr/local/bin && sudo cp /bin-local/supervizio /usr/local/bin/ && sudo chmod +x /usr/local/bin/supervizio" || {
            echo "ERROR: Failed to copy binary"
            exit 1
          }

          echo "=== Step 4: Run install script ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo chmod +x /setup/*.sh && sudo /setup/install.sh" || {
            echo "ERROR: Install script failed"
            # Show diagnostic info
            sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /usr/local/bin/supervizio /etc/rc.d/ 2>/dev/null || true"
            exit 1
          }

          echo "=== Step 5: Check version ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "/usr/local/bin/supervizio --version" || {
            echo "WARNING: Version check failed (may be expected)"
          }

          echo "=== Step 6: Verify installation state before test ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /usr/local/bin/supervizio /etc/rc.d/supervizio 2>/dev/null || ls -la /usr/local/etc/rc.d/supervizio 2>/dev/null || true"

          echo "=== Step 7: Run test script ==="
          sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo sh -x /vagrant/test-install.sh" || {
            echo "ERROR: Test script failed"
            # Show diagnostic info
            sudo -E vagrant ssh ${{ matrix.vm }} -c "ls -la /usr/local/bin/ /etc/rc.d/ /usr/local/etc/rc.d/ 2>/dev/null || true"
            exit 1
          }

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f || true

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          sudo vagrant status || true
          sudo virsh list --all || true
