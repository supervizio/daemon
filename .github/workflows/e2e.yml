name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # =============================================================================
  # E2E Tests on Linux with KVM acceleration (fast native VMs)
  # =============================================================================
  e2e-linux:
    name: E2E Debian (${{ matrix.arch }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            goarch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          file ../bin/supervizio

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Install libvirt and dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            ebtables \
            libguestfs-tools \
            ruby-dev \
            ruby-libvirt \
            build-essential

          sudo systemctl start libvirtd
          sudo systemctl enable libvirtd
          sudo usermod -aG libvirt,kvm $USER

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq vagrant

      - name: Install vagrant-libvirt plugin
        run: |
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-debian12-libvirt-${{ matrix.arch }}-v2

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Cleanup on exit
          trap 'sudo vagrant destroy debian -f 2>/dev/null || true' EXIT

          echo "=== Verifying KVM ==="
          kvm-ok || true
          ls -la /dev/kvm

          echo "=== Starting Debian VM (${{ matrix.arch }}) ==="
          sudo -E vagrant up debian --provider=libvirt --no-parallel

          echo "=== Running installation tests ==="
          sudo -E vagrant ssh debian -c "sudo /vagrant/test-install.sh"

          echo "=== E2E tests passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          sudo vagrant status || true
          echo "=== Vagrant Debug ==="
          sudo vagrant up debian --provider=libvirt --debug 2>&1 | tail -100 || true
          echo "=== Libvirt VMs ==="
          sudo virsh list --all || true
          echo "=== Libvirt Networks ==="
          sudo virsh net-list --all || true
