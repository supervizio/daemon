# =============================================================================
# E2E Tests - Native Architecture Testing on macOS
# =============================================================================
# Tests supervizio on native hardware using FREE standard runners:
# - AMD64: macOS 13 (Intel) - last free Intel macOS runner
# - ARM64: macOS 15 (Apple Silicon) - free standard runner
#
# NOTE: macos-*-large runners are NOT free (require GitHub Team plan)
# Standard runners are free for public repositories.
#
# Each job tests:
# 1. VM: Debian via Vagrant (installation test)
# 2. Container: Debian via Docker (entrypoint test)
#
# Matrix: 2 jobs (1 AMD64 + 1 ARM64)
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # AMD64 E2E Tests (macOS 13 Intel - FREE standard runner)
  # ===========================================================================
  e2e-amd64:
    name: E2E AMD64 (Debian VM + Container)
    runs-on: macos-13
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/amd64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test: Debian via Vagrant + QEMU
      # =========================================================================
      - name: Install Vagrant and QEMU
        run: |
          brew install --cask vagrant
          brew install qemu
          vagrant plugin install vagrant-qemu

      - name: Start Debian VM
        working-directory: e2e
        run: |
          echo "=== Starting Debian VM (AMD64) ==="
          vagrant up debian --provider=qemu
          echo "=== VM started ==="

      - name: Run VM installation test
        working-directory: e2e
        run: |
          echo "=== Running installation tests ==="
          vagrant ssh debian -c "sudo /vagrant/test-install.sh"
          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: vagrant destroy debian -f 2>/dev/null || true

      # =========================================================================
      # Container Test: Debian via Docker
      # =========================================================================
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build Debian container (amd64)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --load \
            -f e2e/Dockerfile.debian \
            -t supervizio-debian:amd64 .
          echo "=== Image info ==="
          docker images supervizio-debian:amd64

      - name: Test Debian container (amd64)
        run: |
          echo "=== Testing supervizio in Debian container (amd64) ==="
          docker run --rm --platform linux/amd64 supervizio-debian:amd64
          echo "=== Container test passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          vagrant status || true
          echo "=== Docker Images ==="
          docker images || true

  # ===========================================================================
  # ARM64 E2E Tests (macOS 15 Apple Silicon - FREE standard runner)
  # ===========================================================================
  e2e-arm64:
    name: E2E ARM64 (Debian VM + Container)
    runs-on: macos-15
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary (linux/arm64)
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio
          echo "=== Binary info ==="
          file ../bin/supervizio
          ls -lh ../bin/supervizio

      # =========================================================================
      # VM Test: Debian via Vagrant + QEMU
      # =========================================================================
      - name: Install Vagrant and QEMU
        run: |
          brew install --cask vagrant
          brew install qemu
          vagrant plugin install vagrant-qemu

      - name: Start Debian VM
        working-directory: e2e
        run: |
          echo "=== Starting Debian VM (ARM64) ==="
          vagrant up debian --provider=qemu
          echo "=== VM started ==="

      - name: Run VM installation test
        working-directory: e2e
        run: |
          echo "=== Running installation tests ==="
          vagrant ssh debian -c "sudo /vagrant/test-install.sh"
          echo "=== VM tests passed ==="

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: vagrant destroy debian -f 2>/dev/null || true

      # =========================================================================
      # Container Test: Debian via Docker
      # =========================================================================
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build Debian container (arm64)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -f e2e/Dockerfile.debian \
            -t supervizio-debian:arm64 .
          echo "=== Image info ==="
          docker images supervizio-debian:arm64

      - name: Test Debian container (arm64)
        run: |
          echo "=== Testing supervizio in Debian container (arm64) ==="
          docker run --rm --platform linux/arm64 supervizio-debian:arm64
          echo "=== Container test passed ==="

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Vagrant Status ==="
          vagrant status || true
          echo "=== Docker Images ==="
          docker images || true
