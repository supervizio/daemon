# =============================================================================
# E2E Tests - Platform Matrix
# =============================================================================
# Tests supervizio across all supported platforms and init systems.
# AMD64 only (setup scripts are architecture-agnostic).
#
# Linux (5 jobs):
#   - Debian 12 (systemd) - Vagrant + Docker
#   - Ubuntu 22.04 (systemd) - Vagrant + Docker
#   - Alpine 3.19 (OpenRC) - Vagrant + Docker
#   - Devuan 4 (SysVinit) - Vagrant + Docker
#   - Void Linux (runit) - Docker only
#
# BSD (4 jobs):
#   - FreeBSD 14.2 (rc.d) - cross-platform-actions
#   - OpenBSD 7.6 (rc.d) - cross-platform-actions
#   - NetBSD 10.0 (rc.d) - cross-platform-actions
#   - DragonFlyBSD 6.4 (rc.d) - Vagrant
#
# Total: 9 jobs
# =============================================================================
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.5'

jobs:
  # ===========================================================================
  # Linux E2E Tests (Vagrant + Docker)
  # ===========================================================================
  e2e-linux:
    name: E2E ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian
            vm: debian13
            dockerfile: Dockerfile.debian
            init: systemd
          - name: Ubuntu
            vm: ubuntu
            dockerfile: Dockerfile.ubuntu
            init: systemd
          - name: Alpine
            vm: alpine
            dockerfile: Dockerfile.alpine
            init: openrc
          - name: Devuan
            vm: devuan
            dockerfile: Dockerfile.devuan
            init: sysvinit
          - name: Void
            vm: void
            dockerfile: Dockerfile.void
            init: runit
            skip_vm: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      # =========================================================================
      # VM Test via Vagrant + libvirt/KVM
      # =========================================================================
      - name: Setup KVM
        if: ${{ matrix.skip_vm != true }}
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        if: ${{ matrix.skip_vm != true }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libvirt-daemon-system libvirt-dev libvirt-clients qemu-kvm ruby-dev ruby-libvirt build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Install Vagrant from HashiCorp
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq && sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        if: ${{ matrix.skip_vm != true }}
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-${{ matrix.vm }}-v1

      - name: Start VM
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt

      - name: Run VM tests
        if: ${{ matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo -E vagrant ssh ${{ matrix.vm }} -c "sudo /vagrant/test-install.sh"

      - name: Cleanup VM
        if: ${{ always() && matrix.skip_vm != true }}
        working-directory: e2e
        run: sudo vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

      - name: Skip VM notice
        if: ${{ matrix.skip_vm == true }}
        run: echo "Skipping VM test for ${{ matrix.name }} (no Vagrant box)"

      # =========================================================================
      # Container Test via Docker
      # =========================================================================
      - name: Build container
        run: docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-${{ matrix.vm }}:test .

      - name: Test container
        run: docker run --rm supervizio-${{ matrix.vm }}:test

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: |
          sudo vagrant status || true
          sudo virsh list --all || true

  # ===========================================================================
  # BSD E2E Tests (cross-platform-actions)
  # ===========================================================================
  e2e-bsd:
    name: E2E ${{ matrix.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: FreeBSD
            os: freebsd
            version: '14.2'
            goos: freebsd
          - name: OpenBSD
            os: openbsd
            version: '7.6'
            goos: openbsd
          - name: NetBSD
            os: netbsd
            version: '10.0'
            goos: netbsd
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      - name: Run VM test
        uses: cross-platform-actions/action@v0.26.0
        with:
          operating_system: ${{ matrix.os }}
          version: ${{ matrix.version }}
          architecture: x86-64
          memory: 4G
          cpu_count: 2
          shell: sh
          sync_files: runner-to-vm
          run: |
            set -e
            uname -a
            sudo mkdir -p /setup /usr/local/bin
            sudo cp -r setup/* /setup/
            sudo cp bin/supervizio /usr/local/bin/
            sudo chmod +x /setup/*.sh /usr/local/bin/supervizio
            sudo /setup/install.sh
            /usr/local/bin/supervizio --version || true
            chmod +x e2e/test-install.sh
            sudo sh e2e/test-install.sh

      - name: Collect logs on failure
        if: failure()
        run: echo "Check cross-platform-actions logs above"

  # ===========================================================================
  # DragonFlyBSD E2E Test (Vagrant - not supported by cross-platform-actions)
  # ===========================================================================
  e2e-dragonfly:
    name: E2E DragonFlyBSD
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/go.sum

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build supervizio binary
        working-directory: src
        env:
          CGO_ENABLED: 0
          GOOS: dragonfly
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o ../bin/supervizio ./cmd/daemon
          chmod +x ../bin/supervizio

      - name: Setup KVM
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libvirt-daemon-system libvirt-dev libvirt-clients qemu-kvm ruby-dev ruby-libvirt build-essential
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Install Vagrant from HashiCorp
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq && sudo apt-get install -y -qq vagrant
          vagrant plugin install vagrant-libvirt

      - name: Cache Vagrant box
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-dragonfly-v1

      - name: Start VM
        working-directory: e2e
        run: sudo -E vagrant up dragonfly --provider=libvirt

      - name: Copy files and run tests
        working-directory: e2e
        run: |
          sudo -E vagrant ssh dragonfly -c "sudo mkdir -p /setup /usr/local/bin"
          sudo -E vagrant scp ../setup dragonfly:/tmp/setup
          sudo -E vagrant scp ../bin/supervizio dragonfly:/tmp/supervizio
          sudo -E vagrant ssh dragonfly -c "sudo cp -r /tmp/setup/* /setup/ && sudo cp /tmp/supervizio /usr/local/bin/ && sudo chmod +x /setup/*.sh /usr/local/bin/supervizio"
          sudo -E vagrant ssh dragonfly -c "sudo /setup/install.sh"
          sudo -E vagrant ssh dragonfly -c "/usr/local/bin/supervizio --version"
          sudo -E vagrant ssh dragonfly -c "sudo sh /vagrant/test-install.sh"

      - name: Collect logs on failure
        if: failure()
        working-directory: e2e
        run: sudo -E vagrant ssh dragonfly -c "uname -a" || true

      - name: Cleanup
        if: always()
        working-directory: e2e
        run: sudo vagrant destroy dragonfly -f || true
