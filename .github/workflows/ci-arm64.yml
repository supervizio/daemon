name: CI (ARM64)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-arm64-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.6'
  WIRE_VERSION: 'v0.7.0'
  RUST_VERSION: 'stable'
  ZIG_VERSION: '0.13.0'

jobs:
  # =============================================================================
  # PHASE 1: QUALITY GATES (shared with x86, but run in parallel)
  # =============================================================================

  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-lint-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-lint-arm64-

      - name: Check formatting
        working-directory: src/lib/probe
        run: cargo fmt --all -- --check

      - name: Run clippy
        working-directory: src/lib/probe
        run: cargo clippy --all-features -- -D warnings

  rust-test:
    name: Rust Test
    runs-on: ubuntu-24.04
    needs: [rust-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-test-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-test-arm64-

      - name: Run tests
        working-directory: src/lib/probe
        run: cargo test

  # =============================================================================
  # PHASE 2: BUILD LIBPROBE (ARM64 platforms)
  # =============================================================================

  # Native ARM64 Linux builds
  build-probe-linux:
    name: Build Probe linux-${{ matrix.platform }}
    runs-on: ubuntu-24.04-arm
    needs: [rust-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: aarch64-unknown-linux-gnu
            platform: linux-arm64
          - rust_target: aarch64-unknown-linux-musl
            platform: linux-arm64-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install musl tools
        if: matrix.musl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq musl-tools

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-arm64-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-arm64-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.musl && 'musl-gcc' || 'gcc' }}
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # BSD ARM64 cross-compilation with Zig
  build-probe-bsd:
    name: Build Probe ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    needs: [rust-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: aarch64-unknown-freebsd
            platform: freebsd-arm64
            zig_target: aarch64-freebsd
          - rust_target: aarch64-unknown-openbsd
            platform: openbsd-arm64
            zig_target: aarch64-openbsd
          - rust_target: aarch64-unknown-netbsd
            platform: netbsd-arm64
            zig_target: aarch64-netbsd
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-${{ matrix.rust_target }}-

      - name: Configure Cargo for Zig cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.${{ matrix.rust_target }}]
          linker = "${{ github.workspace }}/zig-wrapper.sh"
          ar = "zig"
          EOF

          cat > zig-wrapper.sh << 'WRAPPER'
          #!/bin/sh
          exec zig cc -target ${{ matrix.zig_target }} "$@"
          WRAPPER
          chmod +x zig-wrapper.sh

      - name: Build libprobe.a (cross-compile)
        working-directory: src/lib/probe
        env:
          CC: "${{ github.workspace }}/zig-wrapper.sh"
          AR: "zig ar"
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # macOS Apple Silicon (native)
  build-probe-darwin-arm64:
    name: Build Probe darwin-arm64
    runs-on: macos-14
    needs: [rust-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-darwin-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-darwin-arm64-

      - name: Build libprobe.a (native)
        working-directory: src/lib/probe
        run: cargo build --release

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/darwin-arm64
          cp src/lib/probe/target/release/libprobe.a dist/lib/darwin-arm64/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/libprobe.a
          retention-days: 1

  # =============================================================================
  # PHASE 3: GO TESTS (uses linux-arm64 probe)
  # Note: Go tests run on x86 workflow with shared results
  # ARM64 workflow skips separate go-test to avoid duplication
  # =============================================================================

  # =============================================================================
  # PHASE 4: BUILD BINARIES (ARM64 platforms)
  # =============================================================================

  # Linux ARM64 glibc binary
  build-linux-arm64:
    name: Build linux-arm64
    runs-on: ubuntu-24.04-arm
    needs: [build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64
          path: dist/lib/linux-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-arm64 -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-linux-arm64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64
          path: supervizio-linux-arm64
          retention-days: 1

  # Linux ARM64 musl (static) binary
  build-linux-arm64-musl:
    name: Build linux-arm64-musl
    runs-on: ubuntu-24.04-arm
    needs: [build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64-musl
          path: dist/lib/linux-arm64-musl/

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/src \
            -e CGO_ENABLED=1 \
            -e CGO_CFLAGS="-I/workspace/src/lib/probe/include" \
            -e CGO_LDFLAGS="-L/workspace/dist/lib/linux-arm64-musl -lprobe -lm" \
            golang:1.25-alpine \
            sh -c '
              set -euo pipefail
              apk add --no-cache gcc musl-dev file
              go install github.com/google/wire/cmd/wire@v0.7.0
              wire ./internal/bootstrap/
              go build -v \
                -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci -linkmode external -extldflags \"-static\"" \
                -o /workspace/supervizio-linux-arm64-musl \
                ./cmd/daemon
              file /workspace/supervizio-linux-arm64-musl
            '

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64-musl
          path: supervizio-linux-arm64-musl
          retention-days: 1

  # BSD ARM64 binaries (cross-compiled)
  build-bsd-arm64:
    name: Build ${{ matrix.goos }}-arm64
    runs-on: ubuntu-24.04
    needs: [build-probe-bsd]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: freebsd
            probe: freebsd-arm64
          - goos: openbsd
            probe: openbsd-arm64
          - goos: netbsd
            probe: netbsd-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-${{ matrix.probe }}
          path: dist/lib/${{ matrix.probe }}/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Setup Zig as C compiler for CGO
        run: |
          cat > /usr/local/bin/zig-cc-${{ matrix.goos }}-arm64 << 'EOF'
          #!/bin/sh
          exec zig cc -target aarch64-${{ matrix.goos }} "$@"
          EOF
          chmod +x /usr/local/bin/zig-cc-${{ matrix.goos }}-arm64

      - name: Build binary (cross-compile)
        working-directory: src
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: arm64
          CGO_ENABLED: 1
          CC: zig-cc-${{ matrix.goos }}-arm64
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/${{ matrix.probe }} -lprobe -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-${{ matrix.goos }}-arm64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-${{ matrix.goos }}-arm64
          path: supervizio-${{ matrix.goos }}-arm64
          retention-days: 1

  # macOS Apple Silicon binary
  build-darwin-arm64:
    name: Build darwin-arm64
    runs-on: macos-14
    needs: [build-probe-darwin-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/darwin-arm64 -lprobe"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-darwin-arm64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-darwin-arm64
          path: supervizio-darwin-arm64
          retention-days: 1

  # =============================================================================
  # PHASE 5: VERIFY ARTIFACTS
  # =============================================================================

  verify-artifacts:
    name: Verify Artifacts
    runs-on: ubuntu-24.04
    needs: [build-linux-arm64, build-linux-arm64-musl]
    steps:
      - name: Download all ARM64 Linux binaries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: supervizio-linux-arm64*
          merge-multiple: true
          path: bin/

      - name: Verify binaries
        run: |
          set -euo pipefail
          echo "=== Verifying ARM64 binaries ==="
          for bin in bin/supervizio-*; do
            if [ -f "$bin" ]; then
              echo "Checking $bin..."
              file "$bin"
            fi
          done

      - name: Verify musl is static
        run: |
          if [ -f bin/supervizio-linux-arm64-musl ]; then
            if ! file bin/supervizio-linux-arm64-musl | grep -qE "statically linked|static-pie"; then
              echo "ERROR: musl binary is NOT statically linked!"
              exit 1
            fi
            echo "OK: musl binary is static"
          fi

      - name: Generate checksums
        run: |
          cd bin
          sha256sum supervizio-* > checksums.txt
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: checksums-arm64
          path: bin/checksums.txt
          retention-days: 1

  # =============================================================================
  # PHASE 6: E2E TESTS (ARM64)
  # =============================================================================

  e2e-docker-linux:
    name: E2E Docker ARM64 ${{ matrix.name }}
    needs: [build-linux-arm64, build-linux-arm64-musl]
    runs-on: ubuntu-24.04-arm
    continue-on-error: true
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian-glibc
            dockerfile: Dockerfile.debian-script
            artifact: supervizio-linux-arm64
          - name: Alpine-musl
            dockerfile: Dockerfile.alpine-script
            artifact: supervizio-linux-arm64-musl
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Prepare binary
        run: |
          # Rename to linux-amd64 for Dockerfile compatibility (it expects this name)
          mv bin/${{ matrix.artifact }} bin/supervizio-linux-amd64
          file bin/supervizio-linux-amd64

      - name: Build and test container
        run: |
          docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-e2e:${{ matrix.name }}-arm64 .
          docker run --rm supervizio-e2e:${{ matrix.name }}-arm64
          docker run --rm --entrypoint sh supervizio-e2e:${{ matrix.name }}-arm64 -c "
            OUTPUT=\$(/usr/local/bin/supervizio --probe) &&
            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' &&
            echo 'Probe validation passed on ARM64'
          "

  # =============================================================================
  # PHASE 7: PACKAGES (ARM64)
  # =============================================================================

  packages-glibc:
    name: Package ${{ matrix.format }} (arm64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-arm64

      - name: Prepare binary
        run: |
          # Rename to match nfpm expected name
          mv supervizio-linux-arm64 supervizio-linux-arm64-orig
          mv supervizio-linux-arm64-orig supervizio-linux-arm64
          chmod +x supervizio-linux-arm64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: arm64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager ${{ matrix.format }} --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-arm64.${{ matrix.format }}
          path: "*.${{ matrix.format }}"
          retention-days: 1

  packages-musl:
    name: Package apk (arm64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-arm64-musl

      - name: Prepare binary
        run: |
          mv supervizio-linux-arm64-musl supervizio-linux-arm64
          chmod +x supervizio-linux-arm64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: arm64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager apk --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-arm64.apk
          path: "*.apk"
          retention-days: 1
