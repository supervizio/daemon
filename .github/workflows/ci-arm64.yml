name: CI (ARM64)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-arm64-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.6'
  WIRE_VERSION: 'v0.7.0'
  RUST_VERSION: 'stable'
  ZIG_VERSION: '0.13.0'

jobs:
  # =============================================================================
  # PHASE 1: QUALITY GATES
  # =============================================================================

  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-lint-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-lint-arm64-

      - name: Check formatting
        working-directory: src/lib/probe
        run: cargo fmt --all -- --check

      - name: Run clippy
        working-directory: src/lib/probe
        run: cargo clippy --all-features -- -D warnings

  rust-test:
    name: Rust Test
    runs-on: ubuntu-24.04
    needs: [rust-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-test-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-test-arm64-

      - name: Run tests
        working-directory: src/lib/probe
        run: cargo test

  # =============================================================================
  # PHASE 2: BUILD PROBES (ARM64)
  # =============================================================================

  # Linux ARM64 probes (native on ARM runner)
  build-probe-linux:
    name: Probe linux-arm64${{ matrix.suffix }}
    runs-on: ubuntu-24.04-arm
    needs: [rust-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust_target: aarch64-unknown-linux-gnu
            suffix: ""
            platform: linux-arm64
          - rust_target: aarch64-unknown-linux-musl
            suffix: "-musl"
            platform: linux-arm64-musl
            musl: true
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install musl tools
        if: matrix.musl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq musl-tools

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-arm64-${{ matrix.rust_target }}-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-arm64-${{ matrix.rust_target }}-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          CC: ${{ matrix.musl && 'musl-gcc' || 'gcc' }}
        run: cargo build --release --target ${{ matrix.rust_target }} --package probe-ffi

      - name: Prepare artifact
        run: |
          mkdir -p dist/lib/${{ matrix.platform }}
          cp src/lib/probe/target/${{ matrix.rust_target }}/release/libprobe.a dist/lib/${{ matrix.platform }}/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-${{ matrix.platform }}
          path: dist/lib/${{ matrix.platform }}/libprobe.a
          retention-days: 1

  # NOTE: BSD ARM64 probes are disabled because:
  # 1. aarch64-unknown-{freebsd,openbsd,netbsd} are Rust Tier 3 targets
  #    (not available via `rustup target add`, requires -Z build-std on nightly)
  # 2. No Vagrant/VM boxes available for BSD ARM64 testing
  # 3. x86 workflow already tests BSD builds adequately
  # When BSD ARM64 becomes Tier 2 or testing VMs become available, re-enable.

  # macOS ARM64 probe (native on Apple Silicon runner)
  # macOS ARM64 probe (native on Apple Silicon)
  build-probe-darwin:
    name: Probe darwin-arm64
    runs-on: macos-latest
    needs: [rust-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/lib/probe/target
          key: rust-probe-darwin-arm64-${{ hashFiles('src/lib/probe/**/Cargo.toml', 'src/lib/probe/**/Cargo.lock') }}
          restore-keys: |
            rust-probe-darwin-arm64-

      - name: Build libprobe.a
        working-directory: src/lib/probe
        env:
          MACOSX_DEPLOYMENT_TARGET: '14.0'
        run: cargo build --release --target aarch64-apple-darwin --package probe-ffi

      - name: Prepare artifact
        working-directory: src/lib/probe
        run: |
          mkdir -p ${{ github.workspace }}/dist/lib/darwin-arm64
          cp target/aarch64-apple-darwin/release/libprobe.a ${{ github.workspace }}/dist/lib/darwin-arm64/
          ls -la ${{ github.workspace }}/dist/lib/darwin-arm64/

      - name: Upload libprobe artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/libprobe.a
          retention-days: 1

  # =============================================================================
  # PHASE 2.5: GO TESTS (requires libprobe)
  # =============================================================================

  go-test:
    name: Go Test
    runs-on: ubuntu-24.04-arm
    needs: [build-probe-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64
          path: dist/lib/linux-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Run tests
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-arm64 -lprobe -lm"
        run: go test -race ./...

  # =============================================================================
  # PHASE 3: BUILD BINARIES (ARM64)
  # =============================================================================

  # Linux ARM64 glibc binary (standard)
  build-arm64:
    name: Build arm64
    runs-on: ubuntu-24.04-arm
    needs: [build-probe-linux, go-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64
          path: dist/lib/linux-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/linux-arm64 -lprobe -lpthread -ldl -lm"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-linux-arm64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64
          path: supervizio-linux-arm64
          retention-days: 1

  # Linux ARM64 musl binary (static)
  build-arm64-musl:
    name: Build arm64-musl
    runs-on: ubuntu-24.04-arm
    needs: [build-probe-linux, go-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download libprobe (musl)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-linux-arm64-musl
          path: dist/lib/linux-arm64-musl/

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/src \
            -e CGO_ENABLED=1 \
            -e CGO_CFLAGS="-I/workspace/src/lib/probe/include" \
            -e CGO_LDFLAGS="-L/workspace/dist/lib/linux-arm64-musl -lprobe -lm" \
            golang:1.25-alpine \
            sh -c '
              set -euo pipefail
              apk add --no-cache gcc musl-dev file
              go install github.com/google/wire/cmd/wire@v0.7.0
              wire ./internal/bootstrap/
              go build -v \
                -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci -linkmode external -extldflags \"-static\"" \
                -o /workspace/supervizio-linux-arm64-musl \
                ./cmd/daemon
              file /workspace/supervizio-linux-arm64-musl
            '

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-linux-arm64-musl
          path: supervizio-linux-arm64-musl
          retention-days: 1

  # NOTE: BSD ARM64 binary builds disabled - see note above build-probe-bsd

  # macOS ARM64 binary (native on Apple Silicon)
  build-darwin-arm64:
    name: Build darwin-arm64
    runs-on: macos-latest
    needs: [build-probe-darwin, go-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download libprobe
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: libprobe-darwin-arm64
          path: dist/lib/darwin-arm64/

      - name: Install Wire
        run: go install github.com/google/wire/cmd/wire@${{ env.WIRE_VERSION }}

      - name: Generate code
        working-directory: src
        run: wire ./internal/bootstrap/

      - name: Build binary
        working-directory: src
        env:
          CGO_ENABLED: 1
          CGO_CFLAGS: "-I${{ github.workspace }}/src/lib/probe/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/dist/lib/darwin-arm64 -lprobe"
        run: |
          go build -ldflags="-s -w -X github.com/kodflow/daemon/internal/bootstrap.version=0.0.0-ci" \
            -o ../supervizio-darwin-arm64 ./cmd/daemon

      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-darwin-arm64
          path: supervizio-darwin-arm64
          retention-days: 1

  # =============================================================================
  # PHASE 4: VERIFY ALL ARTIFACTS
  # =============================================================================

  verify-artifacts:
    name: Verify All Artifacts
    runs-on: ubuntu-24.04
    needs:
      - build-arm64
      - build-arm64-musl
      - build-darwin-arm64
    steps:
      - name: Download ALL ARM64 binaries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: supervizio-*-arm64*
          merge-multiple: true
          path: bin/

      - name: List all artifacts
        run: |
          echo "=== All ARM64 artifacts ==="
          ls -la bin/
          echo ""
          echo "=== Expected artifacts (ARM64) ==="
          echo "  - supervizio-linux-arm64 (glibc)"
          echo "  - supervizio-linux-arm64-musl (static)"
          echo "  - supervizio-darwin-arm64"
          echo ""
          echo "NOTE: BSD ARM64 binaries disabled (Rust Tier 3, no test VMs)"

      - name: Verify all binaries exist
        run: |
          set -euo pipefail
          # NOTE: BSD ARM64 disabled (Rust Tier 3, no test VMs)
          EXPECTED=(
            "supervizio-linux-arm64"
            "supervizio-linux-arm64-musl"
            "supervizio-darwin-arm64"
          )
          MISSING=0
          for bin in "${EXPECTED[@]}"; do
            if [ -f "bin/$bin" ]; then
              echo "✓ $bin found"
              file "bin/$bin"
            else
              echo "✗ $bin MISSING!"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ "$MISSING" -gt 0 ]; then
            echo "ERROR: $MISSING binaries missing!"
            exit 1
          fi
          echo ""
          echo "All ${#EXPECTED[@]} binaries present."

      - name: Verify musl is static
        run: |
          if [ -f bin/supervizio-linux-arm64-musl ]; then
            if ! file bin/supervizio-linux-arm64-musl | grep -qE "statically linked|static-pie"; then
              echo "ERROR: musl binary is NOT statically linked!"
              file bin/supervizio-linux-arm64-musl
              exit 1
            fi
            echo "✓ musl binary is statically linked"
          fi

      - name: Generate checksums
        run: |
          cd bin
          sha256sum supervizio-* > checksums-arm64.txt
          echo "=== Checksums ==="
          cat checksums-arm64.txt

      - name: Upload checksums
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: checksums-arm64
          path: bin/checksums-arm64.txt
          retention-days: 1

  # =============================================================================
  # PHASE 5: BUILD PACKAGES (after verify)
  # =============================================================================

  packages-glibc:
    name: Package ${{ matrix.format }} (arm64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-arm64

      - name: Prepare binary
        run: chmod +x supervizio-linux-arm64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: arm64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager ${{ matrix.format }} --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-arm64.${{ matrix.format }}
          path: "*.${{ matrix.format }}"
          retention-days: 1

  packages-musl:
    name: Package apk (arm64)
    needs: [verify-artifacts]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-linux-arm64-musl

      - name: Prepare binary
        run: |
          # nfpm expects supervizio-linux-arm64, rename musl version
          mv supervizio-linux-arm64-musl supervizio-linux-arm64
          chmod +x supervizio-linux-arm64

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.44.1

      - name: Build package
        env:
          VERSION: "0.0.0"
          GOARCH: arm64
        run: |
          envsubst < nfpm.yaml > nfpm-resolved.yaml
          nfpm package --config nfpm-resolved.yaml --packager apk --target ./

      - name: Upload package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: supervizio-arm64.apk
          path: "*.apk"
          retention-days: 1

  # =============================================================================
  # PHASE 6: E2E DOCKER TESTS (after packages)
  # =============================================================================

  e2e-docker:
    name: E2E Docker ${{ matrix.name }}
    needs: [packages-glibc, packages-musl]
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: debian-glibc
            dockerfile: Dockerfile.debian-script
            artifact: supervizio-linux-arm64
            description: "Debian with glibc (systemd)"
          - name: alpine-musl
            dockerfile: Dockerfile.alpine-script
            artifact: supervizio-linux-arm64-musl
            description: "Alpine with musl (OpenRC)"
          - name: scratch
            dockerfile: Dockerfile.scratch
            artifact: supervizio-linux-arm64-musl
            description: "Scratch (static binary, no OS)"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Prepare binary
        run: |
          chmod +x bin/${{ matrix.artifact }}
          # Dockerfile.scratch expects bin/supervizio, others expect bin/supervizio-linux-amd64
          if [ "${{ matrix.dockerfile }}" = "Dockerfile.scratch" ]; then
            mv bin/${{ matrix.artifact }} bin/supervizio
            file bin/supervizio
          else
            mv bin/${{ matrix.artifact }} bin/supervizio-linux-amd64
            file bin/supervizio-linux-amd64
          fi

      - name: Build container
        run: |
          docker build -f e2e/${{ matrix.dockerfile }} -t supervizio-e2e:${{ matrix.name }}-arm64 .

      - name: Test container startup
        run: |
          docker run --rm supervizio-e2e:${{ matrix.name }}-arm64

      - name: Validate probe metrics
        if: matrix.dockerfile != 'Dockerfile.scratch'
        run: |
          docker run --rm --entrypoint sh supervizio-e2e:${{ matrix.name }}-arm64 -c "
            set -e
            echo '=== System Info ==='
            uname -a
            cat /etc/os-release 2>/dev/null || true

            echo ''
            echo '=== Running --probe ==='
            OUTPUT=\$(/usr/local/bin/supervizio --probe 2>&1) || {
              echo 'ERROR: --probe failed'
              echo \"Output: \$OUTPUT\"
              exit 1
            }

            echo 'Raw JSON:'
            echo \"\$OUTPUT\"

            echo ''
            echo '=== Validation ==='
            echo \"\$OUTPUT\" | jq -e '.timestamp' > /dev/null && echo '✓ timestamp'
            echo \"\$OUTPUT\" | jq -e '.platform' > /dev/null && echo '✓ platform'
            echo \"\$OUTPUT\" | jq -r '.cpu.cores // \"null\"' | xargs -I {} echo 'cpu.cores = {}'

            echo \"\$OUTPUT\" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
              echo '✓ Probe validation passed: ${{ matrix.description }}'
          "

      - name: Test scratch container (no shell)
        if: matrix.dockerfile == 'Dockerfile.scratch'
        run: |
          echo "=== Testing scratch container (static binary, no OS) ==="
          # Scratch has no shell, can only run the binary directly

          echo "--- Test --version ---"
          docker run --rm supervizio-e2e:scratch-arm64 --version
          echo "✓ --version works"

          echo ""
          echo "--- Test --probe ---"
          OUTPUT=$(docker run --rm supervizio-e2e:scratch-arm64 --probe 2>&1) || {
            echo "ERROR: --probe failed"
            echo "Output: $OUTPUT"
            exit 1
          }
          echo "Probe output:"
          echo "$OUTPUT"

          # Validate JSON structure
          echo ""
          echo "--- Validate JSON ---"
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "✓ timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "✓ platform present"
          echo "$OUTPUT" | jq -e '.cpu.cores > 0' > /dev/null && echo "✓ cpu.cores > 0"
          echo "$OUTPUT" | jq -e '.memory.total > 0' > /dev/null && echo "✓ memory.total > 0"

          echo ""
          echo "✓ Scratch container tests passed"

  # =============================================================================
  # PHASE 7: E2E LINUX VM TESTS (Vagrant + libvirt on ARM64)
  # =============================================================================
  # NOTE: BSD ARM64 VMs disabled - Rust Tier 3 targets, no binaries built

  e2e-vm:
    name: E2E VM ${{ matrix.name }}
    # TODO: restore needs: [packages-glibc, packages-musl] after VM setup works
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # ==============================================================
          # VM names MUST match e2e/Vagrantfile definitions
          # - Init: systemd, OpenRC, SysVinit, runit (4 systems)
          # - Libc: glibc, musl (2 variants)
          # ==============================================================

          # systemd + .deb + glibc
          - name: Debian (systemd/deb)
            vm: debian13
            artifact: supervizio-linux-arm64

          # systemd + .rpm + glibc
          - name: Fedora (systemd/rpm)
            vm: fedora
            artifact: supervizio-linux-arm64

          # OpenRC + .apk + musl
          - name: Alpine (OpenRC/apk)
            vm: alpine
            artifact: supervizio-linux-arm64-musl

          # NOTE: Devuan skipped on ARM64 - no libvirt ARM64 box available
          # SysVinit tested on x86 workflow only

          # runit + .apk + musl
          - name: Alpine-runit (runit/apk)
            vm: alpine-runit
            artifact: supervizio-linux-arm64-musl
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      # TODO: restore after VM setup works
      # - name: Download binary
      #   uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
      #   with:
      #     name: ${{ matrix.artifact }}
      #     path: bin
      #
      # - name: Prepare binary
      #   run: |
      #     chmod +x bin/${{ matrix.artifact }}
      #     file bin/${{ matrix.artifact }}

      - name: Setup KVM
        run: |
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
          fi

      - name: Install libvirt and Vagrant
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          # Install libvirt stack, ARM64 UEFI firmware, and Vagrant dependencies
          sudo apt-get install -y -qq \
            libvirt-daemon-system \
            libvirt-dev \
            libvirt-clients \
            qemu-kvm \
            qemu-system-arm \
            qemu-efi-aarch64 \
            ruby-dev \
            ruby-bundler \
            build-essential \
            pkg-config \
            libarchive-tools
          sudo systemctl start libvirtd
          sudo usermod -aG libvirt,kvm $USER

          # Install Vagrant via Ruby gem (HashiCorp doesn't provide ARM64 packages)
          sudo gem install vagrant --no-document
          vagrant --version

          # Install vagrant-libvirt plugin
          vagrant plugin install vagrant-libvirt

      # Cache disabled - forcing fresh ARM64 box download
      # - name: Cache Vagrant box
      #   uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      #   with:
      #     path: ~/.vagrant.d/boxes
      #     key: vagrant-arm64-${{ matrix.vm }}-v2

      - name: Verify virtualization setup
        run: |
          echo "=== System Architecture ==="
          uname -m

          echo ""
          echo "=== KVM Status ==="
          ls -la /dev/kvm || echo "KVM not available"

          echo ""
          echo "=== AAVMF Firmware ==="
          ls -la /usr/share/AAVMF/ || echo "AAVMF not found"

          echo ""
          echo "=== libvirt Status ==="
          sudo systemctl status libvirtd --no-pager || true
          sudo virsh version || true

          echo ""
          echo "=== Vagrant Info ==="
          vagrant --version
          vagrant plugin list

      - name: Force ARM64 box download
        working-directory: e2e
        run: |
          set -x  # Debug mode
          echo "=== Host Architecture ==="
          uname -m

          # Map VM name to box name
          case "${{ matrix.vm }}" in
            debian13) BOX="generic/debian12" ;;
            fedora) BOX="generic/fedora39" ;;
            alpine|alpine-runit) BOX="generic/alpine319" ;;
            *) echo "Unknown VM: ${{ matrix.vm }}"; exit 1 ;;
          esac

          echo "=== Forcing ARM64 box for $BOX ==="

          # Get the latest version
          VERSION=$(curl -s "https://vagrantcloud.com/api/v2/box/$BOX" | jq -r '.versions[0].version')
          echo "Latest version: $VERSION"

          # Construct ARM64 box URL
          BOX_URL="https://vagrantcloud.com/${BOX}/versions/${VERSION}/providers/libvirt/arm64/vagrant.box"
          echo "Box URL: $BOX_URL"

          # Add box explicitly - DO NOT swallow errors
          echo "=== Downloading box (this may take a while) ==="
          sudo vagrant box add --force --name "$BOX" --provider libvirt "$BOX_URL" 2>&1 || {
            echo "ERROR: vagrant box add failed!"
            echo "Trying alternative: let vagrant download during 'up'"
          }

          echo ""
          echo "=== Installed boxes ==="
          sudo vagrant box list || echo "No boxes installed"

      - name: Start VM
        working-directory: e2e
        run: |
          echo "=== Starting VM ==="
          sudo -E vagrant up ${{ matrix.vm }} --provider=libvirt 2>&1 | tail -100 || {
            echo ""
            echo "=== vagrant up failed ==="
            sudo journalctl -u libvirtd --no-pager -n 30 || true
            exit 1
          }

      - name: Test VM is accessible
        working-directory: e2e
        run: |
          set -uo pipefail

          echo "=== Vagrant status ==="
          sudo -E vagrant status ${{ matrix.vm }}

          echo ""
          echo "=== Vagrant box list (check architecture) ==="
          sudo -E vagrant box list

          echo ""
          echo "=== libvirt domain list ==="
          sudo virsh list --all || true

          echo ""
          echo "=== libvirt domain info ==="
          DOMAIN=$(sudo virsh list --all --name | grep -i ${{ matrix.vm }} | head -1)
          if [ -n "$DOMAIN" ]; then
            sudo virsh dominfo "$DOMAIN" || true
            echo ""
            echo "=== Domain XML (arch info) ==="
            sudo virsh dumpxml "$DOMAIN" | grep -E '<type|<arch|<machine|<loader' || true
          fi

          echo ""
          echo "=== vagrant ssh-config ==="
          sudo -E vagrant ssh-config ${{ matrix.vm }} || true

          echo ""
          echo "=== Waiting for VM to be SSH-ready (up to 1 min) ==="
          for i in $(seq 1 12); do
            if sudo -E vagrant ssh ${{ matrix.vm }} -c "echo 'VM ready'" 2>/dev/null; then
              echo "=== VM is SSH-accessible after $((i*5)) seconds ==="
              sudo -E vagrant ssh ${{ matrix.vm }} -c 'uname -a; cat /etc/os-release 2>/dev/null || true'
              echo ""
              echo "✓ VM ${{ matrix.name }} booted successfully!"
              exit 0
            fi
            sleep 5
          done

          echo "ERROR: VM not SSH-accessible after 60 seconds"
          exit 1

      # TODO: restore after VM setup works
      # - name: Run E2E test in VM
      #   working-directory: e2e
      #   run: |
      #     sudo -E vagrant ssh ${{ matrix.vm }} -c '...'

      - name: Cleanup VM
        if: always()
        working-directory: e2e
        run: sudo -E vagrant destroy ${{ matrix.vm }} -f 2>/dev/null || true

  # =============================================================================
  # PHASE 8: E2E macOS TEST (native on Apple Silicon)
  # =============================================================================

  e2e-macos:
    name: E2E macOS ARM64
    needs: [verify-artifacts]
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: supervizio-darwin-arm64
          path: bin

      - name: Prepare binary
        run: |
          chmod +x bin/supervizio-darwin-arm64
          file bin/supervizio-darwin-arm64

      - name: Run macOS E2E test
        run: |
          set -euo pipefail
          export PATH="$PWD/bin:$PATH"
          mv bin/supervizio-darwin-arm64 bin/supervizio
          chmod +x bin/supervizio

          echo "=== System Info ==="
          uname -a
          sysctl hw.ncpu || true
          sw_vers || true

          echo ""
          echo "=== Test version ==="
          bin/supervizio --version

          echo ""
          echo "=== Test probe ==="
          OUTPUT=$(bin/supervizio --probe 2>&1) || {
            echo "ERROR: --probe command failed with exit code $?"
            echo "Output: $OUTPUT"
            exit 1
          }

          echo "Raw JSON output:"
          echo "$OUTPUT"

          echo ""
          echo "=== Validate JSON structure ==="
          echo "$OUTPUT" | jq -e 'type == "object"' > /dev/null || {
            echo "ERROR: Output is not valid JSON object"
            exit 1
          }

          echo "Checking required fields..."
          echo "$OUTPUT" | jq -e '.timestamp' > /dev/null && echo "✓ timestamp present"
          echo "$OUTPUT" | jq -e '.platform' > /dev/null && echo "✓ platform present"
          echo "$OUTPUT" | jq -e '.cpu' > /dev/null && echo "✓ cpu present" || echo "✗ cpu MISSING"
          echo "$OUTPUT" | jq -r '.cpu.cores // "null"' | xargs -I {} echo "  cpu.cores = {}"

          # Final validation
          echo ""
          echo "=== Final validation ==="
          echo "$OUTPUT" | jq -e '.timestamp and .platform and .cpu.cores > 0' && \
            echo "✓ Probe validation passed on macOS ARM64"
