# =============================================================================
# nfpm configuration for Linux package generation
# =============================================================================
# Generates: .deb (Debian/Devuan), .rpm (Rocky/RHEL), .apk (Alpine),
#            .pkg.tar.zst (Arch/Artix)
# Docs: https://nfpm.goreleaser.com/configuration/
# =============================================================================

name: supervizio
arch: ${GOARCH}
platform: linux
version: ${VERSION}
maintainer: supervizio <noreply@superviz.io>
description: |
  PID1-capable process supervisor for containers and Unix systems.
  Manages multiple services with health checks, restart policies, and log rotation.
vendor: supervizio
homepage: https://github.com/supervizio/daemon
license: MIT

contents:
  # Main binary
  - src: ./supervizio-linux-${GOARCH}
    dst: /usr/local/bin/supervizio
    file_info:
      mode: 0755

  # Example configuration
  - src: ./examples/config.yaml
    dst: /etc/supervizio/config.example.yaml
    type: config|noreplace
    file_info:
      mode: 0644

  # License
  - src: ./LICENSE
    dst: /usr/share/doc/supervizio/LICENSE
    file_info:
      mode: 0644

  # Directories
  - dst: /etc/supervizio
    type: dir
    file_info:
      mode: 0755

  - dst: /var/log/supervizio
    type: dir
    file_info:
      mode: 0755

  # Systemd service file (deb/rpm/archlinux)
  - src: ./setup/init/systemd/supervizio.service
    dst: /usr/lib/systemd/system/supervizio.service
    file_info:
      mode: 0644
    packager: deb

  - src: ./setup/init/systemd/supervizio.service
    dst: /usr/lib/systemd/system/supervizio.service
    file_info:
      mode: 0644
    packager: rpm

  - src: ./setup/init/systemd/supervizio.service
    dst: /usr/lib/systemd/system/supervizio.service
    file_info:
      mode: 0644
    packager: archlinux

  # Dinit service file (archlinux - for Artix)
  - src: ./setup/init/dinit/supervizio
    dst: /etc/dinit.d/supervizio
    file_info:
      mode: 0644
    packager: archlinux

  # runit service files (archlinux - Artix with runit)
  - src: ./setup/init/runit/supervizio/run
    dst: /etc/sv/supervizio/run
    file_info:
      mode: 0755
    packager: archlinux

  - src: ./setup/init/runit/supervizio/log/run
    dst: /etc/sv/supervizio/log/run
    file_info:
      mode: 0755
    packager: archlinux

  # s6 service files (archlinux - Artix with s6)
  - src: ./setup/init/s6/supervizio/run
    dst: /etc/s6/supervizio/run
    file_info:
      mode: 0755
    packager: archlinux

  - src: ./setup/init/s6/supervizio/type
    dst: /etc/s6/supervizio/type
    file_info:
      mode: 0644
    packager: archlinux

  - src: ./setup/init/s6/supervizio/log/run
    dst: /etc/s6/supervizio/log/run
    file_info:
      mode: 0755
    packager: archlinux

  # OpenRC init script (archlinux - Artix with OpenRC)
  - src: ./setup/init/openrc/supervizio
    dst: /etc/init.d/supervizio
    file_info:
      mode: 0755
    packager: archlinux

  # SysVinit script (deb only, for Devuan and similar)
  - src: ./setup/init/sysvinit/supervizio
    dst: /etc/init.d/supervizio
    file_info:
      mode: 0755
    packager: deb

  # OpenRC init script (apk only)
  - src: ./setup/init/openrc/supervizio
    dst: /etc/init.d/supervizio
    file_info:
      mode: 0755
    packager: apk

  # s6 service files (apk - Alpine with s6)
  - src: ./setup/init/s6/supervizio/run
    dst: /etc/s6/supervizio/run
    file_info:
      mode: 0755
    packager: apk

  - src: ./setup/init/s6/supervizio/type
    dst: /etc/s6/supervizio/type
    file_info:
      mode: 0644
    packager: apk

  - src: ./setup/init/s6/supervizio/log/run
    dst: /etc/s6/supervizio/log/run
    file_info:
      mode: 0755
    packager: apk

  # runit service files (apk - Alpine with runit)
  - src: ./setup/init/runit/supervizio/run
    dst: /etc/sv/supervizio/run
    file_info:
      mode: 0755
    packager: apk

  - src: ./setup/init/runit/supervizio/log/run
    dst: /etc/sv/supervizio/log/run
    file_info:
      mode: 0755
    packager: apk

  # dinit service file (apk - Chimera Linux)
  - src: ./setup/init/dinit/supervizio
    dst: /etc/dinit.d/supervizio
    file_info:
      mode: 0644
    packager: apk

# Package-specific overrides
overrides:
  deb:
    scripts:
      postinstall: ./setup/scripts/postinstall-deb.sh
      preremove: ./setup/scripts/preremove-deb.sh

  rpm:
    scripts:
      postinstall: ./setup/scripts/postinstall-rpm.sh
      preremove: ./setup/scripts/preremove-rpm.sh

  apk:
    scripts:
      postinstall: ./setup/scripts/postinstall-apk.sh
      preremove: ./setup/scripts/preremove-apk.sh

  archlinux:
    scripts:
      postinstall: ./setup/scripts/postinstall-arch.sh
      preremove: ./setup/scripts/preremove-arch.sh
