#!/bin/bash
# ============================================================================
# commit-validate.sh - Bloque les commits avec r√©f√©rences IA/Claude
# PreToolUse hook pour Bash(git commit:*)
# Exit 0 = autoris√©, Exit 2 = bloqu√©
# ============================================================================

set -euo pipefail

# Patterns interdits (case insensitive)
FORBIDDEN_PATTERNS=(
    # Co-author patterns
    "co-authored-by.*claude"
    "co-authored-by.*anthropic"
    "co-authored-by.*openai"
    "co-authored-by.*gpt"
    "co-authored-by.*ai"
    "co-authored-by.*copilot"
    "co-authored-by.*gemini"
    "co-authored-by.*llm"
    # Generated by patterns
    "generated.*with.*claude"
    "generated.*by.*claude"
    "generated.*with.*ai"
    "generated.*by.*ai"
    "generated.*with.*gpt"
    "generated.*by.*gpt"
    "ai.assisted"
    "ai-assisted"
    # Direct mentions
    "ü§ñ"
    "claude code"
    "claude-code"
    "anthropic"
    "openai"
    "chatgpt"
    "copilot"
)

# Lire l'input JSON de Claude
INPUT=$(cat)
TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty')
COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')

# V√©rifier si c'est un git commit
if [[ "$TOOL" != "Bash" ]]; then
    exit 0
fi

if [[ ! "$COMMAND" =~ ^git[[:space:]]+commit ]]; then
    exit 0
fi

# Extraire le message de commit
# Patterns: -m "msg", -m 'msg', --message="msg", heredoc
COMMIT_MSG=""

# Pattern 1: -m "message" ou -m 'message'
if [[ "$COMMAND" =~ -m[[:space:]]+[\"\']([^\"\']+)[\"\'] ]]; then
    COMMIT_MSG="${BASH_REMATCH[1]}"
fi

# Pattern 2: -m "$(cat <<..." (heredoc)
if [[ "$COMMAND" =~ cat[[:space:]]+\<\<[\'\"]?EOF ]]; then
    # Extraire tout entre <<EOF et EOF
    COMMIT_MSG=$(echo "$COMMAND" | sed -n '/<<.*EOF/,/EOF/p' | grep -v "EOF" | grep -v "cat <<")
fi

# Pattern 3: --message="..."
if [[ "$COMMAND" =~ --message=[\"\']([^\"\']+)[\"\'] ]]; then
    COMMIT_MSG="${BASH_REMATCH[1]}"
fi

# Si pas de message trouv√©, laisser passer (sera valid√© autrement)
if [[ -z "$COMMIT_MSG" ]]; then
    exit 0
fi

# V√©rifier chaque pattern interdit
COMMIT_MSG_LOWER=$(echo "$COMMIT_MSG" | tr '[:upper:]' '[:lower:]')

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG_LOWER" | grep -qiE "$pattern"; then
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "  ‚ùå COMMIT BLOQU√â - R√©f√©rence IA d√©tect√©e"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        echo "  Pattern interdit trouv√©: $pattern"
        echo ""
        echo "  Message de commit:"
        echo "$COMMIT_MSG" | head -5 | sed 's/^/    /'
        echo ""
        echo "  R√àGLE: Les commits ne doivent JAMAIS contenir:"
        echo "    - Co-Authored-By avec Claude/Anthropic/OpenAI/AI"
        echo "    - Generated by/with AI/Claude/GPT"
        echo "    - Mentions directes d'IA (ü§ñ, claude-code, etc.)"
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        exit 2
    fi
done

# Message valide
echo "‚úì Commit valid√© (pas de r√©f√©rence IA)"
exit 0
