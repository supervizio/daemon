# Daemon Configuration Example
# This file demonstrates the full configuration options for daemon

version: "1"

# Global logging configuration
logging:
  base_dir: /var/log/daemon
  defaults:
    timestamp_format: iso8601
    rotation:
      max_size: 100MB
      max_age: 7d
      max_files: 10
      compress: true

# Service definitions
services:
  # Example web application
  - name: webapp
    command: /usr/bin/node /app/server.js
    working_dir: /app
    user: www-data
    group: www-data
    environment:
      NODE_ENV: production
      PORT: "3000"
    restart:
      policy: always
      max_retries: 5
      delay: 5s
      delay_max: 60s
    health_checks:
      - name: http-health
        type: http
        endpoint: http://localhost:3000/health
        method: GET
        status_code: 200
        interval: 30s
        timeout: 5s
        retries: 3
    logging:
      stdout:
        file: webapp.out.log
        timestamp_format: iso8601
      stderr:
        file: webapp.err.log

  # Example database
  - name: postgres
    command: /usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/data
    user: postgres
    group: postgres
    restart:
      policy: always
      max_retries: 3
      delay: 10s
    health_checks:
      - name: tcp-check
        type: tcp
        host: localhost
        port: 5432
        interval: 15s
        timeout: 5s
        retries: 3
    logging:
      stdout:
        file: postgres.out.log
      stderr:
        file: postgres.err.log

  # Example Redis cache
  - name: redis
    command: /usr/bin/redis-server /etc/redis/redis.conf
    restart:
      policy: on-failure
      max_retries: 5
      delay: 3s
    health_checks:
      - name: redis-ping
        type: command
        command: redis-cli ping
        interval: 10s
        timeout: 2s
        retries: 3

  # Example one-shot initialization task
  - name: db-migrate
    command: /app/migrate up
    working_dir: /app
    oneshot: true
    restart:
      policy: on-failure
      max_retries: 3
      delay: 5s
    depends_on:
      - postgres

  # Example background worker
  - name: worker
    command: /app/worker --queue=default
    working_dir: /app
    user: app
    environment:
      REDIS_URL: redis://localhost:6379
      DATABASE_URL: postgres://localhost/app
    restart:
      policy: always
      max_retries: 10
      delay: 5s
      delay_max: 120s
    depends_on:
      - postgres
      - redis
    logging:
      stdout:
        file: worker.out.log
      stderr:
        file: worker.err.log
