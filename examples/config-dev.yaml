# Development config for testing supervizio
version: "1"

logging:
  base_dir: /tmp/supervizio-dev
  defaults:
    timestamp_format: iso8601
    rotation:
      max_size: "1MB"
      max_files: 3

services:
  # Simple HTTP server on port 8080 (exposed to internet)
  - name: web
    command: python3
    args:
      - "-m"
      - "http.server"
      - "8080"
    restart:
      policy: always
      delay: 2s
    listeners:
      - port: 8080
        exposed: true
        probe:
          type: http
          path: /
          interval: 10s
          timeout: 5s

  # Simple HTTP server on port 8081 (internal API, not exposed)
  - name: api
    command: python3
    args:
      - "-m"
      - "http.server"
      - "8081"
    restart:
      policy: always
      delay: 2s
    listeners:
      - port: 8081
        exposed: false
        probe:
          type: http
          path: /
          interval: 10s
          timeout: 5s

  # TCP echo server using socat on port 9000 (internal only)
  - name: echo
    command: socat
    args:
      - "TCP-LISTEN:9000,fork,reuseaddr"
      - "EXEC:cat"
    restart:
      policy: always
      delay: 2s
    listeners:
      - port: 9000
        exposed: false
        probe:
          type: tcp
          interval: 10s
          timeout: 5s

  # Background worker (no ports)
  - name: worker
    command: /bin/sh
    args:
      - "-c"
      - "while true; do echo '[worker] processing...'; sleep 5; done"
    restart:
      policy: always
      delay: 1s

  # Scheduler (no ports)
  - name: scheduler
    command: /bin/sh
    args:
      - "-c"
      - "while true; do echo '[scheduler] tick'; sleep 10; done"
    restart:
      policy: always
      delay: 1s

  # Metrics collector (no ports)
  - name: metrics
    command: /bin/sh
    args:
      - "-c"
      - "while true; do echo '[metrics] collecting...'; sleep 15; done"
    restart:
      policy: always
      delay: 1s

  # Docker whoami container (port 8082, exposed to internet)
  - name: whoami
    command: /bin/sh
    args:
      - "-c"
      - "docker rm -f supervizio-whoami 2>/dev/null; exec docker run --rm --name supervizio-whoami -p 8082:80 traefik/whoami"
    restart:
      policy: always
      delay: 2s
    listeners:
      - port: 8082
        exposed: true
        probe:
          type: http
          path: /
          interval: 10s
          timeout: 5s

  # Crasher for testing failure handling
  - name: crasher
    command: /bin/sh
    args:
      - "-c"
      - "echo '[crasher] starting...'; sleep 3; echo '[crasher] crashing!'; exit 1"
    restart:
      policy: on-failure
      max_retries: 3
      delay: 2s
