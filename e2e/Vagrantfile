# -*- mode: ruby -*-
# vi: set ft=ruby :
# =============================================================================
# supervizio E2E Testing Vagrantfile
# =============================================================================
# Simplified configuration for macOS runners with QEMU provider.
# The QEMU provider automatically uses the host architecture:
# - macOS Intel (macos-13) → AMD64 VMs
# - macOS Apple Silicon (macos-14) → ARM64 VMs
#
# Currently testing: Debian only (extensible to other distros)
# =============================================================================

# Detect Homebrew path for macOS (ARM64 vs Intel)
def homebrew_prefix
  if RUBY_PLATFORM.include?("arm64") || `uname -m`.strip == "arm64"
    "/opt/homebrew"
  else
    "/usr/local"
  end
end

Vagrant.configure("2") do |config|
  # ===========================================================================
  # Shared folders (rsync works with QEMU provider)
  # ===========================================================================
  config.vm.synced_folder "../setup", "/setup", type: "rsync"
  config.vm.synced_folder "../bin", "/bin-local", type: "rsync"
  config.vm.synced_folder ".", "/vagrant", type: "rsync"

  # ===========================================================================
  # QEMU Provider (macOS with HVF acceleration)
  # ===========================================================================
  config.vm.provider "qemu" do |qe|
    qe.memory = "2048"
    qe.smp = "2"
    qe.qemu_dir = "#{homebrew_prefix}/share/qemu"
    # HVF acceleration for native performance on macOS
    qe.machine_type = "virt,accel=hvf,highmem=on"
    qe.ssh_port = 50022
  end

  # ===========================================================================
  # Libvirt Provider (Linux CI fallback)
  # ===========================================================================
  config.vm.provider "libvirt" do |lv|
    lv.memory = 2048
    lv.cpus = 2
    lv.driver = "kvm"
  end

  # ===========================================================================
  # DEBIAN (systemd) - Primary test VM
  # ===========================================================================
  config.vm.define "debian", primary: true do |v|
    v.vm.box = "generic/debian12"
    v.vm.hostname = "e2e-debian"
    v.vm.provision "shell", inline: "apt-get update -qq && apt-get install -y -qq curl"
  end

  # ===========================================================================
  # Additional distros can be added here when needed
  # ===========================================================================
  #
  # config.vm.define "ubuntu", autostart: false do |v|
  #   v.vm.box = "generic/ubuntu2204"
  #   v.vm.hostname = "e2e-ubuntu"
  #   v.vm.provision "shell", inline: "apt-get update -qq && apt-get install -y -qq curl"
  # end
  #
  # config.vm.define "alpine", autostart: false do |v|
  #   v.vm.box = "generic/alpine319"
  #   v.vm.hostname = "e2e-alpine"
  #   v.vm.provision "shell", inline: "apk update && apk add curl"
  # end
  #
  # config.vm.define "freebsd", autostart: false do |v|
  #   v.vm.box = "generic/freebsd14"
  #   v.vm.hostname = "e2e-freebsd"
  #   v.vm.provision "shell", inline: "pkg install -y curl"
  # end

end
