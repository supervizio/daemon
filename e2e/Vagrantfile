# -*- mode: ruby -*-
# vi: set ft=ruby :
# =============================================================================
# supervizio E2E Testing Vagrantfile
# =============================================================================
# Full matrix of init systems and platforms:
#
# Linux (systemd):
#   - debian13: Debian 13 (trixie) - primary
#   - ubuntu: Ubuntu 24.04 (noble)
#
# Linux (OpenRC):
#   - alpine: Alpine 3.20
#
# Linux (SysVinit):
#   - devuan: Devuan 5 (daedalus) - Debian without systemd
#
# BSD (rc.d):
#   - freebsd: FreeBSD 14
#   - openbsd: OpenBSD 7.5
#   - netbsd: NetBSD 10
#   - dragonfly: DragonFlyBSD 6.4
#
# Providers:
#   - libvirt: Linux CI (KVM acceleration)
#   - qemu: macOS (HVF or TCG)
# =============================================================================

# Detect Homebrew path for macOS (ARM64 vs Intel)
def homebrew_prefix
  if RUBY_PLATFORM.include?("arm64") || `uname -m`.strip == "arm64"
    "/opt/homebrew"
  else
    "/usr/local"
  end
end

# Detect if running in CI (GitHub Actions does NOT support HVF)
def ci_mode?
  ENV['CI'] == 'true' || ENV['GITHUB_ACTIONS'] == 'true'
end

Vagrant.configure("2") do |config|
  # ===========================================================================
  # Shared folders (rsync works with all providers)
  # ===========================================================================
  config.vm.synced_folder "../setup", "/setup", type: "rsync"
  config.vm.synced_folder "../bin", "/bin-local", type: "rsync"
  config.vm.synced_folder ".", "/vagrant", type: "rsync"

  # ===========================================================================
  # QEMU Provider (macOS)
  # ===========================================================================
  config.vm.provider "qemu" do |qe|
    qe.memory = "2048"
    qe.smp = "2"
    qe.qemu_dir = "#{homebrew_prefix}/share/qemu"
    qe.ssh_port = 50022

    # Detect architecture
    is_arm = RUBY_PLATFORM.include?("arm64") || `uname -m`.strip == "arm64"

    if ci_mode?
      # CI mode: Use TCG (software emulation) - HVF not available on GitHub Actions
      qe.net_device = "virtio-net-pci"
      qe.extra_qemu_args = %w(-accel tcg,thread=multi)

      if is_arm
        qe.arch = "aarch64"
        qe.machine = "virt,highmem=on"
        qe.cpu = "cortex-a72"
      else
        qe.arch = "x86_64"
        qe.machine = "q35"
        qe.cpu = "max"
      end
    else
      # Local mode: Use HVF for native performance
      qe.machine = "virt,accel=hvf,highmem=on"
      qe.cpu = "cortex-a72" if is_arm
    end
  end

  # ===========================================================================
  # Libvirt Provider (Linux CI - AMD64 and ARM64)
  # ===========================================================================
  config.vm.provider "libvirt" do |lv|
    lv.memory = 2048
    lv.cpus = 2
    lv.driver = "kvm"

    # ARM64-specific configuration
    is_arm = RUBY_PLATFORM.include?("aarch64") || `uname -m`.strip == "aarch64"
    if is_arm
      lv.loader = "/usr/share/AAVMF/AAVMF_CODE.fd"
      lv.machine_type = "virt"
      lv.cpu_mode = "host-passthrough"
    end
  end

  # ===========================================================================
  # LINUX: systemd
  # ===========================================================================

  # Debian 13 (trixie) - Primary test VM
  config.vm.define "debian13", primary: true do |v|
    v.vm.box = "generic/debian12"  # Use debian12 box until debian13 is available
    v.vm.hostname = "e2e-debian13"
    v.vm.provision "shell", inline: "apt-get update -qq && apt-get install -y -qq curl"
  end

  # Ubuntu 24.04 (noble)
  config.vm.define "ubuntu", autostart: false do |v|
    v.vm.box = "generic/ubuntu2404"
    v.vm.hostname = "e2e-ubuntu"
    v.vm.provision "shell", inline: "apt-get update -qq && apt-get install -y -qq curl"
  end

  # ===========================================================================
  # LINUX: OpenRC
  # ===========================================================================

  # Alpine 3.20
  config.vm.define "alpine", autostart: false do |v|
    v.vm.box = "generic/alpine320"
    v.vm.hostname = "e2e-alpine"
    v.vm.provision "shell", inline: "apk update && apk add curl"
  end

  # ===========================================================================
  # LINUX: SysVinit
  # ===========================================================================

  # Devuan 5 (daedalus) - Debian without systemd
  config.vm.define "devuan", autostart: false do |v|
    v.vm.box = "generic/devuan4"  # Use devuan4 (chimaera) until devuan5 box available
    v.vm.hostname = "e2e-devuan"
    v.vm.provision "shell", inline: "apt-get update -qq && apt-get install -y -qq curl"
  end

  # ===========================================================================
  # LINUX: runit
  # ===========================================================================

  # Void Linux (glibc)
  config.vm.define "void", autostart: false do |v|
    v.vm.box = "voidlinux/voidlinux"
    v.vm.hostname = "e2e-void"
    v.vm.provision "shell", inline: "xbps-install -Syu && xbps-install -y curl"
  end

  # ===========================================================================
  # BSD: rc.d (FreeBSD style)
  # ===========================================================================

  # FreeBSD 14
  config.vm.define "freebsd", autostart: false do |v|
    v.vm.box = "generic/freebsd14"
    v.vm.hostname = "e2e-freebsd"
    v.vm.provision "shell", inline: "pkg install -y curl"
  end

  # OpenBSD 7.5
  config.vm.define "openbsd", autostart: false do |v|
    v.vm.box = "generic/openbsd75"
    v.vm.hostname = "e2e-openbsd"
    v.vm.provision "shell", inline: "pkg_add curl"
  end

  # NetBSD 10
  config.vm.define "netbsd", autostart: false do |v|
    v.vm.box = "generic/netbsd10"
    v.vm.hostname = "e2e-netbsd"
    v.vm.provision "shell", inline: "pkgin -y install curl"
  end

  # DragonFlyBSD 6.4
  config.vm.define "dragonfly", autostart: false do |v|
    v.vm.box = "generic/dragonflybsd64"
    v.vm.hostname = "e2e-dragonfly"
    v.vm.provision "shell", inline: "pkg install -y curl"
  end

end
